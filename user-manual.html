<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Manual</title>
<meta name="author" content="Linus Arver" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Source+Code+Pro">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="lilac.js"></script>
<link rel="stylesheet" type="text/css" href="syntax-highlighting.css"/>
<link rel="stylesheet" type="text/css" href="lilac.css" />
<!-- LILAC_HTML_HEAD -->
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">User Manual</h1>
<div id="table-of-contents" role="doc-toc">

<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h-Concepts">1. Concepts</a>
<ul>
<li><a href="#h-Standard-Resource-Service--SRS">1.1. Standard Resource Service (SRS)</a></li>
</ul>
</li>
<li><a href="#h-Configuration-example">2. Configuration example</a>
<ul>
<li><a href="#h-Main-configuration">2.1. Main configuration</a></li>
<li><a href="#h-Git-resource">2.2. Git resource</a>
<ul>
<li>
<ul>
<li><a href="#h-Fake">2.2.0.1. Fake</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-Kubernetes---kubectl-">2.3. Kubernetes (<code>kubectl</code>)</a>
<ul>
<li><a href="#h-Things-we-have-to-implement">2.3.1. Things we have to implement</a>
<ul>
<li><a href="#h-IN-PROGRESS-SRS--create-time-based-staleness-flagger--easy">2.3.1.1. IN-PROGRESS SRS: create time-based staleness flagger (easy)</a></li>
<li><a href="#h-SRS--create-a-command-timeout-for-shell-commands-that-take-too-long-or-error-out">2.3.1.2. <span class="todo TODO">TODO</span> SRS: create a command timeout for shell commands that take too long or error out</a></li>
</ul>
</li>
<li><a href="#h-Implementation-for--KubeCurrent-lua---get-current-context-namespace">2.3.2. Implementation for <code>KubeCurrent.lua</code> (get current context/namespace)</a>
<ul>
<li><a href="#h-Fake-1">2.3.2.1. Fake</a></li>
</ul>
</li>
<li><a href="#h-Fake--kubectl--for-the-test-environment">2.3.3. Fake <code>kubectl</code> for the test environment</a></li>
<li><a href="#h-Implementation-for--Kube-lua---get-per-cluster-information">2.3.4. Implementation for <code>Kube.lua</code> (get per-cluster information)</a>
<ul>
<li><a href="#h-Fake-2">2.3.4.1. Fake</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-On-correctness">2.4. On correctness</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
NOTE: This manual is not yet ready for consumption. There are many missing
pieces (how to install, how to set up your configuration files, etc). Once the
main architecture settles down in the <a href="developer-manual.html">Developer Manual</a> this User Manual will be
revised accordingly.
</p>

<div id="outline-container-h-Concepts" class="outline-2">
<h2 id="h-Concepts"><span class="section-number-2">1.</span> Concepts</h2>
<div class="outline-text-2" id="text-h-Concepts">
<p>
Ultimately, you will want to provide <code>melbyc</code> with a Lua configuration file,
which will in turn provide it to <code>melbyd</code>. Most of your configuration will be
spent defining resources for the Standard Resource Service that <code>melbyd</code>
provides. This is because SRS generalizes the reading of data through shell
commands that would normally be run inside a shell script.
</p>
</div>

<div id="outline-container-h-Standard-Resource-Service--SRS" class="outline-3">
<h3 id="h-Standard-Resource-Service--SRS"><span class="section-number-3">1.1.</span> Standard Resource Service (SRS)</h3>
<div class="outline-text-3" id="text-h-Standard-Resource-Service--SRS">
<p>
Melby allows you to declaratively define a <b>resource</b> using the Standard
Resource Service. Each resource is a collection of shell commands that when
executed and parsed can create a single "object" of some sort, where the object
is a collection of key-value pairs (also known as a hashmap or dictionary). One
example could be a Git type that has various information about a particular Git
repo on disk at some path. Each object is associated with a type, and this
<b>type</b> information is called the <code>resource_type</code>.
</p>

<p>
Each resource also needs a way to distinguish itself against other resources of
the same type. The <code>resource_id</code> fulfills this role. For example, for the Git
resource type, the <code>resource_id</code> could be the unique path on disk for that Git
repo.
</p>
</div>
</div>
</div>

<div id="outline-container-h-Configuration-example" class="outline-2">
<h2 id="h-Configuration-example"><span class="section-number-2">2.</span> Configuration example</h2>
<div class="outline-text-2" id="text-h-Configuration-example">
<p>
Let's look at what a sample configuration might look like. The only requirement
is that we return a table (in this example, named <code>Config</code>) with a <code>view</code>
function. This function takes an <code>env</code> variable which is a table whose keys and
values reflect the environment variables that <code>melbyc</code> sees when it is invoked
by the user.
</p>
</div>

<div id="outline-container-h-Main-configuration" class="outline-3">
<h3 id="h-Main-configuration"><span class="section-number-3">2.1.</span> Main configuration</h3>
<div class="outline-text-3" id="text-h-Main-configuration">
<p>
We import the above into our main configuration, at <code>melby.lua</code>.
</p>

<p>
Note that we <code>require</code> the <code>Git</code>, <code>KubeCurrent</code>, and <code>Kube</code> packages.
This requires setting the <code>LUA_PATH</code> for melbyd when it starts up. Example:
</p>

<pre class="example" id="org0000000">
LUA_PATH="./?.lua;./?/init.lua;$PWD/test/sample/?.lua" make repl
</pre>

<p>
The question marks are replaced with the Lua module name. For Luerl, it uses
the LUA_PATH environment variable <a href="https://github.com/rvirding/luerl/blob/fc668ef337b04ca2aee83c648cf6853dab8babe6/src/luerl_lib_package.erl#L83">here</a>.
</p>

<p>
In our case, we should do 2 things:
</p>

<ol class="org-ol">
<li>in tests, make sure to set the LUA_PATH correctly (to the sample config
folder as above), and</li>
<li>in production, add the $HOME/.melby folder as a path.</li>
</ol>

<p>
Another option is to modify the package.path global variable like this:
</p>

<pre class="example" id="org0000001">
package.path = 'function/?.lua;' .. package.path
require "Git"
</pre>


<div class="org-src-container"><pre class="src src-lua" id="nil-1"><span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Make LUA_PATH also include $HOME/.melby/?.lua.</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Make melbyc use the above path as a default if it's there, and only</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">overwrite it with the FILEPATH argument (move this FILEPATH argument to an</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">optional, not required, flag).</span>
<span class="org-keyword">local</span> <span class="org-variable-name">Git</span> = <span class="org-builtin">require</span> <span class="org-string">"Git"</span>
<span class="org-keyword">local</span> <span class="org-variable-name">KubeCurrent</span> = <span class="org-builtin">require</span> <span class="org-string">"KubeCurrent"</span>
<span class="org-keyword">local</span> <span class="org-variable-name">Kube</span> = <span class="org-builtin">require</span> <span class="org-string">"Kube"</span>

Config = {}
Config[<span class="org-string">"render_options"</span>] = {
  format = <span class="org-string">"RENDER_FORMAT_UNIX_TERMINAL"</span>,
  color_depth = <span class="org-string">"RENDER_COLOR_DEPTH_24_BIT"</span>
}

<span class="org-comment-delimiter">-- </span><span class="org-comment">This is required for both verification and reducing the inputs (env vars) to</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">a known subset.</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Also, strip the given env vars coming from melbyc down to only these</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">env vars. This forces the user to be explicity up-front (at this level)</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">exactly which env vars they expect to use.</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Require that these env vars are specified as keys for each element in</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">Config.validation's env_vars</span>
Config.view_params_types = {
  env={
    HOME                      = {<span class="org-string">"required"</span>, <span class="org-string">"path"</span>},
    HOST                      = {<span class="org-string">"required"</span>, <span class="org-string">"string"</span>},
    <span class="org-comment-delimiter">-- </span><span class="org-comment">"paths" means 1 or more colon-separated paths (no colons if only 1 path).</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">We don't need to bother with a real file on disk because we will never</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">actually read this path; for validation</span>
    KUBECONFIG                = {<span class="org-string">"required"</span>, <span class="org-string">"paths"</span>},
    MELBY_DIR                  = {<span class="org-string">"required"</span>, <span class="org-string">"path"</span>},
    MELBY_LAST_CMD_EXIT_STATUS = {<span class="org-string">"required"</span>, <span class="org-string">"int"</span>},
    <span class="org-comment-delimiter">-- </span><span class="org-comment">"pathblob" is like "path", except that it represents the *contents* of a</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">path. The filename is generated automatically using a temp folder plus</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">the name of the env var.</span>
    MELBY_PATH_ALIASES_FILE    = {<span class="org-string">"required"</span>, <span class="org-string">"pathblob"</span>},
    MELBY_TIME_ZONE            = {<span class="org-string">"optional"</span>, <span class="org-string">"string"</span>},
    MELBY_UNIX_SECONDS         = {<span class="org-string">"optional"</span>, <span class="org-string">"uint"</span>},
    MELBY_ZSH_KEYMAP_INDICATOR = {<span class="org-string">"required"</span>, <span class="org-string">"string"</span>},
    PWD                       = {<span class="org-string">"required"</span>, <span class="org-string">"path"</span>},
    USER                      = {<span class="org-string">"required"</span>, <span class="org-string">"string"</span>},
  },
  shell_pid                   = {<span class="org-string">"required"</span>, <span class="org-string">"uint"</span>}
}

<span class="org-comment-delimiter">-- </span><span class="org-comment">Return an array of array of env var overrides and substrings. For the</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">substrings, these are substrings that must be present in the output of the</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">Config.view() function.</span>
<span class="org-comment-delimiter">--</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">We have to override some env vars because otherwise they become polluted with</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">real paths that are coming from the actual melbyc invocation. For the</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">"preview" (fake) environment we want to control, ideally, all the env vars in</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">allowed_env_vars...!</span>
<span class="org-comment-delimiter">--</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Set all env vars in allowed_env_vars to make it deterministic. Also</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">probably set the shell_pid as well to make the function truly pure.</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: rename env_var_overrides to something else because we're overriding</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">_every_ env var that matters to us.</span>
Config.view_tests = {
  <span class="org-comment-delimiter">-- </span><span class="org-comment">time_idx 0</span>
  {env={
    HOME                      = <span class="org-string">"/home/alice"</span>,
    HOST                      = <span class="org-string">"laptop"</span>,
    KUBECONFIG                = <span class="org-string">"/home/alice/.kube/config"</span>,
    <span class="org-comment-delimiter">-- </span><span class="org-comment">We don't actually need to have a real /home/alice/.melby folder with other</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Lua files in it, because by the time this entire config is read, we</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">already parsed in all the Lua files we need. So this MELBY_DIR is really</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">just a placeholder.</span>
    MELBY_DIR                  = <span class="org-string">"/home/alice/.melby"</span>,
    MELBY_LAST_CMD_EXIT_STATUS = <span class="org-string">"0"</span>,
    <span class="org-comment-delimiter">-- </span><span class="org-comment">this is a "blobpath". the actual value here used in the env var will</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">point to a temporary filename which has the contents here.</span>
    MELBY_PATH_ALIASES_FILE    =
        <span class="org-string">[[</span>
<span class="org-string">            # Kubernetes.</span>
<span class="org-string">            hash -d   ki=${HOME}/go/src/github.com/kubernetes/k8s.io</span>
<span class="org-string">            hash -d   kk=${HOME}/go/src/k8s.io/kubernetes</span>
<span class="org-string">            hash -d   kr=${HOME}/go/src/k8s.io/release</span>
<span class="org-string">            hash -d   kt=${HOME}/go/src/k8s.io/test-infra</span>
<span class="org-string">            hash -d  cip=${HOME}/go/src/sigs.k8s.io/k8s-container-image-promoter</span>

<span class="org-string">            # Notes and dotfiles.</span>
<span class="org-string">            hash -d    l=${HOME}/lo</span>
<span class="org-string">            hash -d    s=${HOME}/syscfg</span>
<span class="org-string">        ]]</span>,
    MELBY_TIME_ZONE            = <span class="org-string">"America/Los_Angeles"</span>,
    MELBY_UNIX_SECONDS         = <span class="org-string">"1679032715"</span>,
    MELBY_ZSH_KEYMAP_INDICATOR = <span class="org-string">"I"</span>,
    PWD                       = <span class="org-string">"/repo/a"</span>,
    USER                      = <span class="org-string">"alice"</span>,
   },
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: move shell_pid to an env_var to unify all inputs into env_vars.</span>
  shell_pid                   = <span class="org-string">"54311"</span>,
  expected_substrings={<span class="org-string">"K8s..."</span>, <span class="org-string">"Git..."</span>}},
}

<span class="org-keyword">function</span> <span class="org-function-name">Config.view</span> (<span class="org-variable-name">env</span>, <span class="org-variable-name">shell_pid</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets_ps1_line1</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets_ps1_line2</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: We need a fake version of get_path_aliases as well, because we don't</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">want to actually read from disk, but let the user instead specify the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">*contents* of such a file.</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">path_aliases</span> = melbyd.get_path_aliases(env[<span class="org-string">"MELBY_PATH_ALIASES_FILE"</span>])

  <span class="org-keyword">local</span> <span class="org-variable-name">pwd</span> = env[<span class="org-string">"PWD"</span>]
  <span class="org-keyword">local</span> <span class="org-variable-name">pwd_pretty_options</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">We try to fit under this length if possible.</span>
  pwd_pretty_options[<span class="org-string">"shorten_threshold"</span>] = 30
  pwd_pretty_options[<span class="org-string">"aliases"</span>] = path_aliases
  pwd_pretty_options[<span class="org-string">"env"</span>] = env
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Make melbyd.get_path_pretty return a LIST of strings that should be</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">joined with the path separator ("/"). Each element can have fields such as</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">color and type (whether it's a regular folder or symlink) as well as the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">owner and permissions on it. For the first element (possibly an alias), we</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">can have a field to denote whether it's an alias. All of these bits of</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">information can be colorized a different way to give semantic coloring to</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">the final colorized path.</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">pwd_pretty_str</span> = melbyd.get_path_pretty(pwd, pwd_pretty_options)

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Get the current time. In non-test-code, we can just call melbyd.get_time("%d</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">C %H:%M:%S %Z")</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">unix_seconds</span> = env[<span class="org-string">"MELBY_UNIX_SECONDS"</span>] <span class="org-keyword">or</span> melbyd.get_unix_seconds()
  <span class="org-keyword">local</span> <span class="org-variable-name">tz</span> = env[<span class="org-string">"MELBY_TIME_ZONE"</span>] <span class="org-keyword">or</span> <span class="org-string">"LOCAL"</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">time_day_name</span> = melbyd.get_time(<span class="org-string">"%a"</span>, unix_seconds, tz)
  <span class="org-keyword">local</span> <span class="org-variable-name">day_in_kanji</span> = {}
  day_in_kanji[<span class="org-string">"Mon"</span>] = <span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x6708) <span class="org-comment-delimiter">-- </span><span class="org-comment">"&#26376;"</span>
  day_in_kanji[<span class="org-string">"Tue"</span>] = <span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x706b) <span class="org-comment-delimiter">-- </span><span class="org-comment">"&#28779;"</span>
  day_in_kanji[<span class="org-string">"Wed"</span>] = <span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x6c34) <span class="org-comment-delimiter">-- </span><span class="org-comment">"&#27700;"</span>
  day_in_kanji[<span class="org-string">"Thu"</span>] = <span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x6728) <span class="org-comment-delimiter">-- </span><span class="org-comment">"&#26408;"</span>
  day_in_kanji[<span class="org-string">"Fri"</span>] = <span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x91d1) <span class="org-comment-delimiter">-- </span><span class="org-comment">"&#37329;"</span>
  day_in_kanji[<span class="org-string">"Sat"</span>] = <span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x571f) <span class="org-comment-delimiter">-- </span><span class="org-comment">"&#22303;"</span>
  day_in_kanji[<span class="org-string">"Sun"</span>] = <span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x65e5) <span class="org-comment-delimiter">-- </span><span class="org-comment">"&#26085;"</span>

  <span class="org-keyword">local</span> <span class="org-variable-name">time_day_name_kanji</span> = day_in_kanji[time_day_name]
  <span class="org-keyword">local</span> <span class="org-variable-name">time_str</span> = melbyd.get_time(<span class="org-string">" %m-%d "</span> .. time_day_name_kanji ..
                                   <span class="org-string">" %H:%M:%S %Z "</span>, unix_seconds, tz)
  <span class="org-keyword">local</span> <span class="org-variable-name">time</span> = {str=time_str, fg=<span class="org-string">"black"</span>, bg=<span class="org-string">"gold"</span>, styles={<span class="org-string">"bold"</span>}}
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line1, time)

  <span class="org-keyword">local</span> <span class="org-variable-name">time_utc_day_name</span> = melbyd.get_time(<span class="org-string">"%a"</span>, env[<span class="org-string">"MELBY_UNIX_SECONDS"</span>],
                                            <span class="org-string">"Etc/UTC"</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">time_utc_day_name_kanji</span> = day_in_kanji[time_utc_day_name]
  <span class="org-keyword">local</span> <span class="org-variable-name">time_utc_str</span> = melbyd.get_time(<span class="org-string">" %m-%d "</span> .. time_utc_day_name_kanji ..
                                       <span class="org-string">" %H:%M:%S %Z "</span>, unix_seconds, <span class="org-string">"Etc/UTC"</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">time_utc</span> = {str=time_utc_str, fg=<span class="org-string">"black"</span>, bg=<span class="org-string">"pink"</span>, styles={<span class="org-string">"bold"</span>}}
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line1, time_utc)

  <span class="org-keyword">local</span> <span class="org-variable-name">zki_str</span> = env[<span class="org-string">"MELBY_ZSH_KEYMAP_INDICATOR"</span>] <span class="org-keyword">or</span> <span class="org-string">"I"</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">zki</span> = {str=<span class="org-string">" &lt;"</span> .. zki_str .. <span class="org-string">"&gt; "</span>, fg=<span class="org-string">"white"</span>, styles={<span class="org-string">"bold"</span>}}
  <span class="org-keyword">if</span> zki_str == <span class="org-string">"N"</span> <span class="org-keyword">then</span>
    zki.fg = <span class="org-string">"black"</span>
    zki.bg = <span class="org-string">"lightskyblue"</span>
  <span class="org-keyword">end</span>
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line1, zki)

  <span class="org-keyword">local</span> <span class="org-variable-name">last_command_exit_status_str</span> = env[<span class="org-string">"MELBY_LAST_CMD_EXIT_STATUS"</span>] <span class="org-keyword">or</span> <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">last_command_exit_status</span> = {str=<span class="org-string">" "</span> .. last_command_exit_status_str .. <span class="org-string">" "</span>,
                                    fg=<span class="org-string">"black"</span>, bg=<span class="org-string">"red"</span>, styles={<span class="org-string">"bold"</span>}}
  <span class="org-keyword">if</span> #last_command_exit_status_str &gt; 0 <span class="org-keyword">and</span> last_command_exit_status_str ~= <span class="org-string">"0"</span> <span class="org-keyword">then</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line1, last_command_exit_status)
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Create a one-shot message for testing (when we want to publish an ad-hoc</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">message).</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--</span><span class="org-comment">local message = {topic="srs_Git", from="/home/l/prog/melby", payload={level="info", text="Hello world"}}</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--</span><span class="org-comment">melbyd.broadcast("srs_Git", message)</span>

  user = env[<span class="org-string">"USER"</span>] <span class="org-keyword">or</span> <span class="org-string">"user"</span>
  host = env[<span class="org-string">"HOST"</span>] <span class="org-keyword">or</span> <span class="org-string">"host"</span>
  user_host = {str=(user .. <span class="org-string">"@"</span> .. host)}
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line1, user_host)

  pwd_pretty = {str=pwd_pretty_str, fg=<span class="org-string">"cyan"</span>, styles={<span class="org-string">"bold"</span>}}
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line1, pwd_pretty)

  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Run Kube.read() for every Kubernetes context found in the set of</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">MELBY_KUBE_CONTEXTS.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">get_kube_contexts(env["MELBY_KUBE_CONTEXTS"])</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">example: "ctx1,ctx2,ctx3"</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Need to loop this around multiple context:namespace combos, probably</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">encoded in MELBY_KUBE_CONTEXTS</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--</span><span class="org-comment">local kube_standard_resource = Kube:read("kind-kind-prow-integration",</span>
  <span class="org-comment-delimiter">--</span><span class="org-comment">"default", env["MELBY_DIR"])</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--</span><span class="org-comment">local kube_widgets = Kube.view(kube_standard_resource)</span>
  <span class="org-comment-delimiter">--</span><span class="org-comment">for _, w in ipairs(kube_widgets) do</span>
  <span class="org-comment-delimiter">--  </span><span class="org-comment">table.insert(widgets_ps1_line2, w)</span>
  <span class="org-comment-delimiter">--</span><span class="org-comment">end</span>

  <span class="org-keyword">local</span> <span class="org-variable-name">kubecurrent_standard_resource</span> = KubeCurrent:read(env,
                                                         {<span class="org-string">"KUBECONFIG"</span>, <span class="org-string">"HOME"</span>})
  <span class="org-keyword">local</span> <span class="org-variable-name">health_resource</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">health_resource_status</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">health_widgets</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">health_str</span> = <span class="org-string">""</span>
  <span class="org-keyword">if</span> kubecurrent_standard_resource.status ==
       <span class="org-string">"STANDARD_RESOURCE_STATUS_LOADED"</span> <span class="org-keyword">then</span>
    health_resource = Kube:read(kubecurrent_standard_resource.kvs.context,
                                kubecurrent_standard_resource.kvs.namespace,
                                env[<span class="org-string">"MELBY_DIR"</span>])
    health_resource_status = health_resource.status
    health_widgets = Kube.view(health_resource)
    health_str = melbyd.render(health_widgets, {str=<span class="org-string">" "</span>})
  <span class="org-keyword">end</span>

  <span class="org-keyword">local</span> <span class="org-variable-name">kubecurrent_widgets</span> = KubeCurrent.view(kubecurrent_standard_resource,
                                               health_resource.status,
                                               health_str)
  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">w</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(kubecurrent_widgets) <span class="org-keyword">do</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line2, w)
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Note that because Git:read() returns very quickly (we designed the backend</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">to be asynchronous), we don't need to worry about parallelism at the Lua</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">configuration level.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Get git information for PWD, if any. We use "MELBY_DIR" so that we can use</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">it in the Git.readers() function for calling custom scripts at custom</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">locations (wherever MELBY_DIR points to).</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">git_standard_resource</span> = Git:read(env, {<span class="org-string">"PWD"</span>, <span class="org-string">"MELBY_DIR"</span>})
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Use the standard widgets that come with the "Git.lua" module.</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">git_widgets</span> = Git.view(git_standard_resource)
  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">w</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(git_widgets) <span class="org-keyword">do</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets_ps1_line2, w)
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Render widgets. Some go into line 1, others into line 2.</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">ps1_line1</span> = melbyd.render(widgets_ps1_line1, {str=<span class="org-string">" "</span>})
  <span class="org-keyword">local</span> <span class="org-variable-name">ps1_line2</span> = melbyd.render(widgets_ps1_line2, {str=<span class="org-string">" "</span>})

  <span class="org-comment-delimiter">-- </span><span class="org-comment">We need to get messages first because we need to subscribe first. Otherwise</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Git SRS will start first and we'll miss its first broadcast (how long the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">initial read took).</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">messages</span> = melbyd.get_shell_messages(shell_pid,
                                            {Git, KubeCurrent},
                                            {PWD=env[<span class="org-string">"PWD"</span>],
                                             KUBECONFIG=(env[<span class="org-string">"KUBECONFIG"</span>] <span class="org-keyword">or</span> <span class="org-string">""</span>)})
  <span class="org-keyword">local</span> <span class="org-variable-name">message_strs</span> = {}
  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">message</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(messages) <span class="org-keyword">do</span>
    <span class="org-keyword">if</span> message[<span class="org-string">"topic"</span>] == <span class="org-string">"srs_Git"</span> <span class="org-keyword">then</span>
      message_str = Git.message_to_string(message, pwd_pretty_options)
    <span class="org-keyword">elseif</span> message[<span class="org-string">"topic"</span>] == <span class="org-string">"srs_KubeCurrent"</span> <span class="org-keyword">then</span>
      message_str = KubeCurrent.message_to_string(message)
    <span class="org-keyword">end</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(message_strs, message_str .. <span class="org-string">"\n"</span>)
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Create a dictionary of shell variables to create.</span>
  export = {}
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(export, {name=<span class="org-string">"MELBY_PS1_LINE1"</span>, val=ps1_line1, <span class="org-builtin">type</span>=<span class="org-string">"string"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(export, {name=<span class="org-string">"MELBY_PS1_LINE2"</span>, val=ps1_line2, <span class="org-builtin">type</span>=<span class="org-string">"string"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(export, {name=<span class="org-string">"MELBY_SHELL_MESSAGES"</span>, val=message_strs,
                        <span class="org-builtin">type</span>=<span class="org-string">"array"</span>})

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Create a shell script that instantiates the exported variables.</span>
  script = melbyd.to_shell_script(export)
  <span class="org-keyword">return</span> script
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">This line is to force evaluation of these loaded modules by Luerl, such that</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">they show up in the loaded vm state.</span>
<span class="org-keyword">return</span> {g = Git, kc = KubeCurrent, k = Kube}
</pre></div>
</div>
</div>

<div id="outline-container-h-Git-resource" class="outline-3">
<h3 id="h-Git-resource"><span class="section-number-3">2.2.</span> Git resource</h3>
<div class="outline-text-3" id="text-h-Git-resource">
<p>
FIXME: break this up into multiple chunks for smaller bits of explanation
(prefer to maximize prose comments here instead of comments in the Lua code).
</p>

<div class="org-src-container"><pre class="src src-lua" id="nil-2"><span class="org-comment-delimiter">-- </span><span class="org-comment">Git Lua module for melby.</span>
<span class="org-keyword">local</span> <span class="org-variable-name">Git</span> = {}
Git[<span class="org-string">"type"</span>] = <span class="org-string">"Git"</span>
Git[<span class="org-string">"history_size"</span>] = 10
Git[<span class="org-string">"parser"</span>] = {}
Git[<span class="org-string">"fake"</span>] = <span class="org-builtin">require</span> <span class="org-string">"GitFake"</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Read the state of the world for this Git repo. Relies on Git.model.readers to</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">get the job done.</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.read</span> (<span class="org-builtin">self</span>, <span class="org-variable-name">env</span>, <span class="org-variable-name">var_names</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">resource_opts</span> = {}
  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">var_name</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(var_names) <span class="org-keyword">do</span>
    resource_opts[var_name] = env[var_name]
  <span class="org-keyword">end</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Gets the current state of the SRS GenServer's latest "head" of this</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">resource. This is because this resource can have a number of states stored</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">in its history (and here we retrieve the first one). Also note that this</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">call is very cheap because sometimes we will just read the already-stored</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">history item (that is, calling this function may or may not result in</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">running the Git.model.readers() commands).</span>
  <span class="org-keyword">return</span> melbyd.read_standard_resource(<span class="org-builtin">self</span>, resource_opts)
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Used to generate a unique resource_id. E.g., for Git, this is the absolute</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">folder path of the git root folder. This is because for Git, clients can</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">legitimately ask questions about the Git repo as long as they are in a child</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">folder under the root. Other resources that are filesystem-based will likely</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">be the same (e.g., direnv).</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.resource_id_command</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">pwd</span> = resource_opts[<span class="org-string">"PWD"</span>]
  <span class="org-keyword">return</span> {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"rev-parse"</span>, <span class="org-string">"--show-toplevel"</span>}}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.readers</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">pwd</span> = resource_opts[<span class="org-string">"PWD"</span>]
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Each reader needs an associated parser. The parser function is just the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">string name of a Git.parser.* function name. So parser="diff" refers to</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Git.parser.diff().</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Move the invocation definition to a function, and put this function</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">next to each parser function.</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">readers</span> = {
    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"diff"</span>, <span class="org-string">"--shortstat"</span>},
     parser=<span class="org-string">"diff"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"diff"</span>, <span class="org-string">"--shortstat"</span>, <span class="org-string">"--cached"</span>},
     parser=<span class="org-string">"diff_cached"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"diff"</span>, <span class="org-string">"--numstat"</span>},
     parser=<span class="org-string">"diff_binary"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"diff"</span>, <span class="org-string">"--numstat"</span>, <span class="org-string">"--cached"</span>},
     parser=<span class="org-string">"diff_cached_binary"</span>},

    {cd=pwd, invocation={(resource_opts[<span class="org-string">"MELBY_DIR"</span>] <span class="org-keyword">or</span> <span class="org-string">""</span>) ..
         <span class="org-string">"/git_staged_bytes.sh"</span>, <span class="org-string">"quiet"</span>},
     parser=<span class="org-string">"staged_bytes"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"log"</span>, <span class="org-string">"--no-walk"</span>,
                         <span class="org-string">"--format=head_author_date,%at%n"</span> ..
                           <span class="org-string">"head_author_name,%an%n"</span> ..
                           <span class="org-string">"head_committer_date,%ct%n"</span> ..
                           <span class="org-string">"head_committer_name,%cn"</span>,
                         <span class="org-string">"HEAD"</span>},
     parser=<span class="org-string">"head_metadata"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"ls-files"</span>, <span class="org-string">"--others"</span>, <span class="org-string">"--exclude-standard"</span>},
     parser=<span class="org-string">"untracked_files"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"ls-files"</span>, <span class="org-string">"-v"</span>},
     parser=<span class="org-string">"assume_unchanged_files"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"rev-list"</span>, <span class="org-string">"--left-right"</span>, <span class="org-string">"--count"</span>,
                         <span class="org-string">"HEAD...@{upstream}"</span>},
     parser=<span class="org-string">"count_head_vs_upstream"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"rev-parse"</span>, <span class="org-string">"--abbrev-ref"</span>, <span class="org-string">"HEAD"</span>},
     parser=<span class="org-string">"head_branch"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"rev-parse"</span>, <span class="org-string">"HEAD"</span>},
     parser=<span class="org-string">"head_sha"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"rev-parse"</span>, <span class="org-string">"--is-bare-repository"</span>},
     parser=<span class="org-string">"bare"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"stash"</span>, <span class="org-string">"list"</span>},
     parser=<span class="org-string">"stash_size"</span>},

    {cd=pwd, invocation={<span class="org-string">"git"</span>, <span class="org-string">"submodule"</span>, <span class="org-string">"status"</span>},
     parser=<span class="org-string">"submodule_status"</span>},
  }
  <span class="org-keyword">return</span> readers
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Staleness flaggers are objects that mark staleness. A stale resource is</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">refreshed (by re-reading the state of the world). Here we define a</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">filesystem-based staleness flagger which marks the model as stale, based on a</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">simple algorithm that ignores changes to Git index files (these files are</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">modified by the "git" binary).</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.staleness_flaggers</span> (<span class="org-variable-name">resource_id</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">repo_root</span> = resource_id
  <span class="org-keyword">local</span> <span class="org-variable-name">filesystem</span> = {}
  filesystem[<span class="org-string">"type"</span>] = <span class="org-string">"filesystem"</span>
  filesystem[<span class="org-string">"watch_paths"</span>] = {repo_root}

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Custom logic to check how to detect cache invalidation, and whether to also</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">invalidate all parent SRS GenServers up along the path (if any).</span>
  filesystem[<span class="org-string">"fs_event_handler"</span>] = <span class="org-keyword">function</span> (<span class="org-variable-name">path</span>, <span class="org-variable-name">events</span>)
    <span class="org-comment-delimiter">-- </span><span class="org-comment">For index files (".git/**/index.lock"), ignore all events except just</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">":modified".</span>
    <span class="org-comment-delimiter">--</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">When we do get a :modified event, this can happen</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">if HEAD moves, which is important when we (for example) modify the</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">HEAD of submodules.</span>
    <span class="org-keyword">if</span> <span class="org-builtin">string</span>.<span class="org-builtin">find</span>(path, <span class="org-string">"/.git/"</span>) <span class="org-keyword">and</span> <span class="org-builtin">string</span>.<span class="org-builtin">find</span>(path, <span class="org-string">"/index.lock$"</span>) <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME note: Looks like</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">https://github.com/rvirding/luerl/blob/5e61c1838d08430af67fb870995b05a41d64aeee/src/luerl.erl#L340</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">converts an atom into a "binary" (string). This just drops the initial</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">":" and makes the rest a string as is.</span>
      <span class="org-keyword">if</span> #events == 1 <span class="org-keyword">and</span> events[1] == <span class="org-string">"modified"</span> <span class="org-keyword">then</span>
        <span class="org-keyword">return</span> <span class="org-constant">true</span>
      <span class="org-keyword">else</span>
        <span class="org-comment-delimiter">-- </span><span class="org-comment">For index files, ignore all other events such as [:modified, :closed]</span>
        <span class="org-comment-delimiter">-- </span><span class="org-comment">which can also happen with [:created] and [:deleted] whenever we</span>
        <span class="org-comment-delimiter">-- </span><span class="org-comment">invoke certain Git read-only operations (e.g., git status).</span>
        <span class="org-keyword">return</span> <span class="org-constant">false</span>
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">NOTE: Conceivably, if we're using jj, we could also ignore any changes</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">going into the "/.jj/" folder.</span>
    <span class="org-keyword">return</span> <span class="org-constant">true</span>
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">We can technically have multiple staleness flaggers, although there can be</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">only 1 filesystem one (because all filesystem events are fed to the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">fs_event_handler above).</span>
  <span class="org-keyword">return</span> {filesystem}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.diff</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Example input strings:</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">" 1 file changed, 32 insertions(+), 2 deletions(-)"</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">" 1 file changed, 35 insertions(+)"</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">" 1 file changed, 8 deletions(-)"</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Note that the "unstaged_files" here does include changed binary files.</span>
  ret[<span class="org-string">"unstaged_files"</span>] = melbyd.get_int_group(s, <span class="org-string">"(\\d+) fil"</span>)
  ret[<span class="org-string">"unstaged_insertions"</span>] = melbyd.get_int_group(s, <span class="org-string">"(\\d+) ins"</span>)
  ret[<span class="org-string">"unstaged_deletions"</span>] = melbyd.get_int_group(s, <span class="org-string">"(\\d+) del"</span>)

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Same as Git.parser.diff, but with slightly different keys.</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.diff_cached</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}
  ret[<span class="org-string">"staged_files"</span>] = melbyd.get_int_group(s, <span class="org-string">"(\\d+) fil"</span>)
  ret[<span class="org-string">"staged_insertions"</span>] = melbyd.get_int_group(s, <span class="org-string">"(\\d+) ins"</span>)
  ret[<span class="org-string">"staged_deletions"</span>] = melbyd.get_int_group(s, <span class="org-string">"(\\d+) del"</span>)

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Only count binary files that have changed. Simply count the number of lines</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">that start with "-".</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.diff_binary</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Example input:</span>
  <span class="org-comment-delimiter">--    </span><span class="org-comment">5   1   doc/build-literate.org</span>
  <span class="org-comment-delimiter">--    </span><span class="org-comment">-   -   doc/melby.html</span>

  ret[<span class="org-string">"unstaged_files_binary"</span>] = melbyd.get_lines_matching_count(s, <span class="org-string">"-"</span>)

  <span class="org-keyword">return</span> melbyd.cast_values(ret, {unstaged_files_binary=<span class="org-string">"int"</span>})
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Same as Git.parser.diff, but with slightly different keys.</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.diff_cached_binary</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}
  ret[<span class="org-string">"staged_files_binary"</span>] = melbyd.get_lines_matching_count(s, <span class="org-string">"-"</span>)

  <span class="org-keyword">return</span> melbyd.cast_values(ret, {staged_files_binary=<span class="org-string">"int"</span>})
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.untracked_files</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  <span class="org-keyword">local</span> <span class="org-variable-name">lines</span> = melbyd.get_lines_trimmed_nonempty(s)
  ret[<span class="org-string">"untracked_files"</span>] = #lines

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.submodule_status</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  <span class="org-keyword">local</span> <span class="org-variable-name">lines</span> = melbyd.get_lines_trimmed_nonempty(s)

  <span class="org-keyword">local</span> <span class="org-variable-name">uninitialzed</span> = 0
  <span class="org-keyword">local</span> <span class="org-variable-name">out_of_sync</span> = 0
  <span class="org-keyword">local</span> <span class="org-variable-name">merge_conflicts</span> = 0

  <span class="org-keyword">for</span> <span class="org-variable-name">i</span>=1,#lines <span class="org-keyword">do</span>
    <span class="org-keyword">local</span> <span class="org-variable-name">c</span> = <span class="org-builtin">string</span>.<span class="org-builtin">sub</span>(lines[i], 1, 1)
    <span class="org-keyword">if</span> c == <span class="org-string">"-"</span> <span class="org-keyword">then</span>
      uninitialzed = uninitialzed + 1
    <span class="org-keyword">elseif</span> c == <span class="org-string">"+"</span> <span class="org-keyword">then</span>
      out_of_sync = out_of_sync + 1
    <span class="org-keyword">elseif</span> c == <span class="org-string">"U"</span> <span class="org-keyword">then</span>
      merge_conflicts = merge_conflicts + 1
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  ret[<span class="org-string">"submodule_uninitialized"</span>] = uninitialzed
  ret[<span class="org-string">"submodule_out_of_sync"</span>] = out_of_sync
  ret[<span class="org-string">"submodule_merge_conflicts"</span>] = merge_conflicts

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.head_branch</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  <span class="org-comment-delimiter">-- </span><span class="org-comment">This is "HEAD" if we are in detached HEAD state.</span>
  ret[<span class="org-string">"head_branch"</span>] = melbyd.get_trimmed(s)

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.head_sha</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  ret[<span class="org-string">"head_sha"</span>] = melbyd.get_trimmed(s)

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.bare</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  ret[<span class="org-string">"bare"</span>] = melbyd.get_trimmed(s)

  <span class="org-keyword">return</span> melbyd.cast_values(ret, {bare=<span class="org-string">"bool"</span>})
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">This function can fail even inside a normal Git repo (with "fatal: no</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">upstream configured for branch 'BRANCH_NAME").</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.count_head_vs_upstream</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">if</span> #s == 0 <span class="org-keyword">then</span>
    <span class="org-keyword">return</span> {count_upstream_to_head=0, count_head_to_upstream=0}
  <span class="org-keyword">end</span>

  ret = melbyd.get_columnar_fields_zipped(s,
                                         {<span class="org-string">"count_upstream_to_head"</span>,
                                          <span class="org-string">"count_head_to_upstream"</span>})

  <span class="org-keyword">return</span> melbyd.cast_values(ret, {count_upstream_to_head=<span class="org-string">"int"</span>,
                                 count_head_to_upstream=<span class="org-string">"int"</span>})
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.stash_size</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  <span class="org-keyword">local</span> <span class="org-variable-name">lines</span> = melbyd.get_lines_trimmed_nonempty(s)
  ret[<span class="org-string">"stash_size"</span>] = #lines

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.staged_bytes</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  <span class="org-keyword">if</span> #s &gt; 0 <span class="org-keyword">then</span>
    ret[<span class="org-string">"staged_bytes"</span>] = <span class="org-builtin">tonumber</span>(s)
  <span class="org-keyword">else</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">This can happen if the command failed (generated an empty string).</span>
    ret[<span class="org-string">"staged_bytes"</span>] = 0
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> melbyd.cast_values(ret, {staged_bytes=<span class="org-string">"int"</span>})
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.assume_unchanged_files</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  <span class="org-keyword">local</span> <span class="org-variable-name">lines</span> = melbyd.get_lines_trimmed_nonempty(s)

  <span class="org-keyword">local</span> <span class="org-variable-name">count</span> = 0

  <span class="org-keyword">for</span> <span class="org-variable-name">i</span>=1,#lines <span class="org-keyword">do</span>
    <span class="org-keyword">local</span> <span class="org-variable-name">ascii_num</span> = <span class="org-builtin">string</span>.<span class="org-builtin">byte</span>(<span class="org-builtin">string</span>.<span class="org-builtin">sub</span>(lines[i], 1, 1))
    <span class="org-comment-delimiter">-- </span><span class="org-comment">According to git-ls-files(1), the "-v" flag marks assume-unchanged files</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">with a leading lowercase letter.</span>
    <span class="org-keyword">if</span> 0x61 &lt;= ascii_num <span class="org-keyword">and</span> ascii_num &lt;= 0x7a <span class="org-keyword">then</span>
      count = count + 1
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  ret[<span class="org-string">"assume_unchanged_files"</span>] = count

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.parser.head_metadata</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}
  ret = melbyd.get_kv_lines_as_map(s)
  <span class="org-keyword">return</span> melbyd.cast_values(ret, {head_author_date=<span class="org-string">"int"</span>,
                                 head_committer_date=<span class="org-string">"int"</span>})
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.notify</span> (<span class="org-variable-name">resource_id</span>, <span class="org-variable-name">old</span>, <span class="org-variable-name">new</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">repo_root</span> = resource_id
  <span class="org-keyword">local</span> <span class="org-variable-name">message</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Look at overall state of the old resource versus the new resource. Generate</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">messages for interesting state changes.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">This is where we need to warn users about linting errors and such.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: If this is a "Rust" codebase, we could have a "Rust" model that</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">performs linter and formatter checks.</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">If we stage or unstage something, show tentative "commit size".</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">old_staged_bytes</span> = old.kvs.staged_bytes
  <span class="org-keyword">local</span> <span class="org-variable-name">new_staged_bytes</span> = new.kvs.staged_bytes
  melbyd.log(<span class="org-string">"old_staged_bytes: "</span> .. old_staged_bytes)
  melbyd.log(<span class="org-string">"new_staged_bytes: "</span> .. new_staged_bytes)
  <span class="org-keyword">if</span> new_staged_bytes ~= old_staged_bytes <span class="org-keyword">then</span>
    <span class="org-keyword">local</span> <span class="org-variable-name">size_rating</span> = <span class="org-string">""</span>

    <span class="org-comment-delimiter">-- </span><span class="org-comment">The sizes here are taken from the following geometric series:</span>
    <span class="org-comment-delimiter">--</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">ghci&gt; map (\x -&gt; round $ 2.718281828^x) [1..10]</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">[3,7,20,55,148,403,1097,2981,8103,22026]</span>

    <span class="org-keyword">if</span> new_staged_bytes &lt; 55 <span class="org-keyword">then</span>
      size_rating = <span class="org-string">"XS"</span>
    <span class="org-keyword">elseif</span> new_staged_bytes &lt; 148 <span class="org-keyword">then</span>
      size_rating = <span class="org-string">"S"</span>
    <span class="org-keyword">elseif</span> new_staged_bytes &lt; 403 <span class="org-keyword">then</span>
      size_rating = <span class="org-string">"M"</span>
    <span class="org-keyword">elseif</span> new_staged_bytes &lt; 1097 <span class="org-keyword">then</span>
      size_rating = <span class="org-string">"L"</span>
    <span class="org-keyword">elseif</span> new_staged_bytes &lt; 2981 <span class="org-keyword">then</span>
      size_rating = <span class="org-string">"XL"</span>
    <span class="org-keyword">else</span>
      size_rating = <span class="org-string">"XXL"</span>
    <span class="org-keyword">end</span>
    message[<span class="org-string">"topic"</span>]=<span class="org-string">"srs_Git"</span>
    message[<span class="org-string">"from"</span>]=repo_root

    <span class="org-keyword">if</span> new_staged_bytes == 0 <span class="org-keyword">then</span>
      message[<span class="org-string">"payload"</span>]={level=<span class="org-string">"info"</span>,
                          text=<span class="org-string">"Staging area is now empty (nothing to commit)."</span>}
    <span class="org-keyword">else</span>
      message[<span class="org-string">"payload"</span>]={level=<span class="org-string">"info"</span>,
                          text=<span class="org-string">"Staged size is now "</span> .. size_rating ..
                            <span class="org-string">" ("</span> .. new_staged_bytes .. <span class="org-string">" bytes)."</span>}
    <span class="org-keyword">end</span>
    melbyd.broadcast(<span class="org-string">"srs_Git"</span>, message)
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> <span class="org-constant">nil</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">For a ShellLogger that is receiving a message from us (Git resource), only</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">keep messages where the repo path is a prefix of the shell's pwd. To keep the</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">message, return true.</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.should_keep_message</span> (<span class="org-variable-name">message</span>, <span class="org-variable-name">env_vars</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">pwd</span> = env_vars[<span class="org-string">"PWD"</span>]
  <span class="org-keyword">local</span> <span class="org-variable-name">i</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">repo_path</span> = message[<span class="org-string">"from"</span>]

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Discard message if the message was malformed and we could not determine the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">"repo path".</span>
  <span class="org-keyword">if</span> repo_path == <span class="org-constant">nil</span> <span class="org-keyword">then</span>
    melbyd.log(<span class="org-string">"repo_path is nil --- dropping"</span>)
    <span class="org-keyword">return</span> <span class="org-constant">false</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">if</span> pwd == repo_path <span class="org-keyword">then</span>
    <span class="org-keyword">return</span> <span class="org-constant">true</span>
  <span class="org-keyword">end</span>

  i, _ = <span class="org-builtin">string</span>.<span class="org-builtin">find</span>(pwd, repo_path)
  <span class="org-keyword">local</span> <span class="org-variable-name">repo_path_in_pwd_hierarchy</span> = i == 1
  <span class="org-keyword">if</span> repo_path_in_pwd_hierarchy <span class="org-keyword">then</span>
    melbyd.log(<span class="org-string">"repo_path "</span> .. repo_path ..
               <span class="org-string">" is in pwd hierarchy (pwd is "</span> .. pwd .. <span class="org-string">"); KEEPING"</span>)
  <span class="org-keyword">else</span>
    melbyd.log(<span class="org-string">"repo_path "</span> .. repo_path ..
               <span class="org-string">" is NOT in pwd hierarchy (pwd is "</span> .. pwd .. <span class="org-string">"); dropping"</span>)
  <span class="org-keyword">end</span>
  <span class="org-keyword">return</span> repo_path_in_pwd_hierarchy
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Git.message_to_string</span> (<span class="org-variable-name">message</span>, <span class="org-variable-name">pwd_pretty_options</span>)
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Example:</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--   </span><span class="org-comment">[22:33:37] [info] [ Git ] ~/prog/melby: Staging area is now empty (nothing to commit).</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">repo_path_pretty</span> = melbyd.get_path_pretty(message[<span class="org-string">"from"</span>],
                                                  pwd_pretty_options)
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"  ["</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"time"</span>] .. <span class="org-string">"]"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"["</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"level"</span>] .. <span class="org-string">"]"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"[ Git ]"</span>, fg=<span class="org-string">"lime"</span>, styles={<span class="org-string">"bold"</span>}})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=repo_path_pretty, fg=<span class="org-string">"yellow"</span>, styles={<span class="org-string">"bold"</span>},
                         drop_delim_right=<span class="org-constant">true</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">": "</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"text"</span>]})

  <span class="org-keyword">return</span> melbyd.render(widgets, {str=<span class="org-string">" "</span>})
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Function for rendering a Git model. Generates a list of widgets.</span>
<span class="org-keyword">function</span> <span class="org-function-name">Git.view</span> (<span class="org-variable-name">standard_resource</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">git</span> = standard_resource[<span class="org-string">"kvs"</span>]

  <span class="org-comment-delimiter">-- </span><span class="org-comment">If this is an initial inquiry into a brand new, uncached Git repo path</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">(uncached as in Melby has not started tracking it yet), return a special "[</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Git... ]" string.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">We do "next(table) == nil" to check if a table is truly empty, as per</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">https://stackoverflow.com/a/1252776/437583.</span>
  <span class="org-keyword">if</span> standard_resource.status == <span class="org-string">"STANDARD_RESOURCE_STATUS_LOADING"</span> <span class="org-keyword">and</span>
    (<span class="org-builtin">next</span>(git) == <span class="org-constant">nil</span>) <span class="org-keyword">then</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"[ Git... ]"</span>})
  <span class="org-keyword">elseif</span> (<span class="org-keyword">not</span> git.bare) <span class="org-keyword">and</span> git.head_sha <span class="org-keyword">then</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"["</span>, drop_delim_right=<span class="org-constant">true</span>})
    colored_sha = melbyd.get_colorized_sha(git.head_sha, 8, 1, 1)
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=colored_sha})

    <span class="org-keyword">if</span> git.head_branch ~= <span class="org-string">""</span> <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=git.head_branch, fg=<span class="org-string">"white"</span>, styles={<span class="org-string">"bold"</span>}})
    <span class="org-keyword">end</span>

    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=melbyd.get_relative_age_short(
                             git.head_committer_date),
                           fg=<span class="org-string">"deepskyblue"</span>})

    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=melbyd.get_truncated_personal_moniker(
                             git.head_author_name, 6),
                           fg=<span class="org-string">"lime"</span>})

    <span class="org-keyword">if</span> git.count_upstream_to_head &gt; 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Unfortunately, luerl does not appear to support "\u{...}" Lua 5.3</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">syntax for encoding Unicode codepoints. So we have to use the</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">utf8.char() function instead.</span>
      <span class="org-comment-delimiter">--</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">For completeness, "&#9650;" is codepoint 0x25b2.</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x25b2), drop_delim_right=<span class="org-constant">true</span>,
                             fg=<span class="org-string">"lime"</span>})
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.count_upstream_to_head)})
    <span class="org-keyword">end</span>

    <span class="org-keyword">if</span> git.count_head_to_upstream &gt; 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">For completeness, "&#9660;" is codepoint 0x25bc.</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x25bc), drop_delim_right=<span class="org-constant">true</span>,
                             fg=<span class="org-string">"red"</span>})
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.count_head_to_upstream)})
    <span class="org-keyword">end</span>

    <span class="org-keyword">if</span> (git.unstaged_files + git.unstaged_files_binary +
        git.unstaged_insertions + git.unstaged_deletions) &gt; 0 <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"U"</span>, fg=<span class="org-string">"cyan"</span>, styles={<span class="org-string">"bold"</span>},
                             drop_delim_right=<span class="org-constant">true</span>})
      <span class="org-keyword">if</span> git.unstaged_files &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.unstaged_files)})
      <span class="org-keyword">end</span>
      <span class="org-keyword">if</span> git.unstaged_files_binary &gt; 0 <span class="org-keyword">then</span>
        <span class="org-comment-delimiter">-- </span><span class="org-comment">For completeness, "&#9629;" is codepoint 0x259d.</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x259d), fg=<span class="org-string">"greenyellow"</span>,
                               styles={<span class="org-string">"bold"</span>},
                               drop_delim_left=<span class="org-constant">true</span>, drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.unstaged_files_binary)})
      <span class="org-keyword">end</span>
      <span class="org-keyword">if</span> git.unstaged_insertions &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"+"</span>, fg=<span class="org-string">"lime"</span>,
                               drop_delim_left=<span class="org-constant">true</span>, drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.unstaged_insertions),
                               fg=<span class="org-string">"lime"</span>})
      <span class="org-keyword">end</span>
      <span class="org-keyword">if</span> git.unstaged_deletions &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"-"</span>, fg=<span class="org-string">"tomato"</span>, drop_delim_left=<span class="org-constant">true</span>,
                               drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.unstaged_deletions),
                               fg=<span class="org-string">"tomato"</span>})
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>

    <span class="org-keyword">if</span> (git.staged_files + git.staged_files_binary +
        git.staged_insertions + git.staged_deletions) &gt; 0 <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"S"</span>, fg=<span class="org-string">"pink"</span>, styles={<span class="org-string">"bold"</span>},
                             drop_delim_right=<span class="org-constant">true</span>})
      <span class="org-keyword">if</span> git.staged_files &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.staged_files)})
      <span class="org-keyword">end</span>
      <span class="org-keyword">if</span> git.staged_files_binary &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(0x259d), fg=<span class="org-string">"greenyellow"</span>,
                               styles={<span class="org-string">"bold"</span>},
                               drop_delim_left=<span class="org-constant">true</span>, drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.staged_files_binary)})
      <span class="org-keyword">end</span>
      <span class="org-keyword">if</span> git.staged_insertions &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"+"</span>, fg=<span class="org-string">"lime"</span>, drop_delim_left=<span class="org-constant">true</span>,
                               drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.staged_insertions), fg=<span class="org-string">"lime"</span>})
      <span class="org-keyword">end</span>
      <span class="org-keyword">if</span> git.staged_deletions &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"-"</span>, fg=<span class="org-string">"tomato"</span>, drop_delim_left=<span class="org-constant">true</span>,
                               drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.staged_deletions), fg=<span class="org-string">"tomato"</span>})
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>

    <span class="org-keyword">if</span> git.untracked_files &gt; 0 <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"N"</span>, drop_delim_right=<span class="org-constant">true</span>, fg=<span class="org-string">"gold"</span>,
                             styles={<span class="org-string">"bold"</span>}})
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.untracked_files)})
    <span class="org-keyword">end</span>

    <span class="org-keyword">if</span> git.stash_size &gt; 0 <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"T"</span>, drop_delim_right=<span class="org-constant">true</span>, fg=<span class="org-string">"purple"</span>,
                             styles={<span class="org-string">"bold"</span>}})
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.stash_size)})
    <span class="org-keyword">end</span>

    <span class="org-keyword">if</span> git.assume_unchanged_files &gt; 0 <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"A"</span>, drop_delim_right=<span class="org-constant">true</span>, fg=<span class="org-string">"red"</span>,
                             styles={<span class="org-string">"bold"</span>}})
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.assume_unchanged_files)})
    <span class="org-keyword">end</span>

    <span class="org-keyword">if</span> (git.submodule_uninitialized + git.submodule_out_of_sync +
        git.submodule_merge_conflicts) &gt; 0 <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"M"</span>, drop_delim_right=<span class="org-constant">true</span>, fg=<span class="org-string">"skyblue"</span>,
                             styles={<span class="org-string">"bold"</span>}})
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"{"</span>, drop_delim_right=<span class="org-constant">true</span>})
      <span class="org-keyword">if</span> git.submodule_uninitialized &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"not_init="</span>, drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.submodule_uninitialized)})
      <span class="org-keyword">end</span>

      <span class="org-keyword">if</span> git.submodule_out_of_sync &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"need_sync="</span>, drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.submodule_out_of_sync)})
      <span class="org-keyword">end</span>

      <span class="org-keyword">if</span> git.submodule_merge_conflicts &gt; 0 <span class="org-keyword">then</span>
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"conflict="</span>, drop_delim_right=<span class="org-constant">true</span>})
        <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">tostring</span>(git.submodule_merge_conflicts)})
      <span class="org-keyword">end</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"}"</span>, drop_delim_left=<span class="org-constant">true</span>})
    <span class="org-keyword">end</span>

    <span class="org-comment-delimiter">-- </span><span class="org-comment">Append asterisk if Melby is serving stale data.</span>
    <span class="org-keyword">if</span> standard_resource.status == <span class="org-string">"STANDARD_RESOURCE_STATUS_LOADING"</span> <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"]*"</span>, drop_delim_left=<span class="org-constant">true</span>})
    <span class="org-keyword">else</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"]"</span>, drop_delim_left=<span class="org-constant">true</span>})
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> widgets
<span class="org-keyword">end</span>

<span class="org-keyword">return</span> Git
</pre></div><p>
Below is a script for determining the absolute size of staged contents (where
both additions and deletions are treated as positive numbers).
</p>

<div class="org-src-container"><pre class="src src-sh" id="nil-3"><span class="org-builtin">set</span> -euo pipefail

<span class="org-comment-delimiter"># </span><span class="org-comment">Example output from "git diff-index HEAD --cached" (the "..." is not literally</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">there and is used to truncate these outputs to reasonable width):</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">:100644 100644 1c458f... 32db82... M      doc/melbyd-model.org</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">:100644 000000 9c4640... 000000... D      melbyd/test/sample/.melby.lua</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">:000000 100755 000000... bdfb82... A      melbyd/test/sample/staged_size.sh</span>

<span class="org-function-name">__bytes</span>()
{
  2&gt;/dev/null git cat-file -s <span class="org-string">"${1}"</span> || <span class="org-builtin">echo</span> 0
}

<span class="org-function-name">__log</span>()
{
  [[ <span class="org-string">"${log_level}"</span> == <span class="org-string">"quiet"</span> ]] &amp;&amp; <span class="org-keyword">return</span>
  <span class="org-builtin">echo</span> &gt;&amp;2 <span class="org-string">"$@"</span>
}

<span class="org-function-name">main</span>()
{
  <span class="org-variable-name">log_level</span>=<span class="org-string">"${1:-normal}"</span>

  <span class="org-variable-name">GIT_ROOT</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">git rev-parse --show-toplevel</span><span class="org-string">)"</span>
  <span class="org-builtin">cd</span> <span class="org-string">"${GIT_ROOT}"</span>

  <span class="org-variable-name">bare</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">git rev-parse --is-bare-repository</span><span class="org-string">)"</span>
  <span class="org-keyword">if</span> [[ <span class="org-string">"${bare}"</span> == true ]]; <span class="org-keyword">then</span>
      <span class="org-builtin">echo</span> 0
      <span class="org-keyword">exit</span>
  <span class="org-keyword">fi</span>

  <span class="org-builtin">mapfile</span> -t array &lt; &lt;(git diff-index HEAD --cached)

  <span class="org-variable-name">total</span>=0
  <span class="org-keyword">for</span> line<span class="org-keyword"> in</span> <span class="org-string">"${array[@]}"</span>; <span class="org-keyword">do</span>
    <span class="org-variable-name">parts</span>=($<span class="org-variable-name">line</span>)
    <span class="org-variable-name">path</span>=${<span class="org-variable-name">parts</span>[5]}

    <span class="org-comment-delimiter"># </span><span class="org-comment">If the path is not to be counted because it is treated as binary in</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">.gitattributes, skip it.</span>
    <span class="org-keyword">if</span> git check-attr diff -- <span class="org-string">"${path}"</span> | grep -q <span class="org-string">"diff: unset"</span>; <span class="org-keyword">then</span>
      <span class="org-keyword">continue</span>
    <span class="org-keyword">fi</span>

    <span class="org-variable-name">mode</span>=${<span class="org-variable-name">parts</span>[4]}
    <span class="org-variable-name">old</span>=$(<span class="org-sh-quoted-exec">__bytes ${parts[2]}</span>)
    <span class="org-variable-name">new</span>=$(<span class="org-sh-quoted-exec">__bytes ${parts[3]}</span>)
    __log <span class="org-string">"path=${path}"</span>
    __log <span class="org-string">"mode=${mode}"</span>
    __log <span class="org-string">"old=${old}"</span>
    __log <span class="org-string">"new=${new}"</span>
    <span class="org-variable-name">delta</span>=0
    <span class="org-keyword">case</span> <span class="org-string">"${mode}"</span><span class="org-keyword"> in</span>
      A) <span class="org-variable-name">delta</span>=<span class="org-string">"${new}"</span> ;;
      M) <span class="org-variable-name">delta</span>=$(<span class="org-sh-quoted-exec">( new - old </span>)) ;;
      D) <span class="org-variable-name">delta</span>=<span class="org-string">"${old}"</span> ;;
    <span class="org-keyword">esac</span>
    <span class="org-variable-name">delta</span>=<span class="org-string">"${delta#-}"</span>
    __log <span class="org-string">"delta=${delta}"</span>
    __log
    <span class="org-variable-name">total</span>=$(<span class="org-sh-quoted-exec">( total + delta </span>))
  <span class="org-keyword">done</span>

  <span class="org-builtin">echo</span> <span class="org-string">"${total}"</span>
}

main <span class="org-string">"$@"</span>
</pre></div>
</div>

<div id="outline-container-h-Fake" class="outline-5">
<h5 id="h-Fake"><span class="section-number-5">2.2.0.1.</span> Fake</h5>
<div class="outline-text-5" id="text-h-Fake">
<div class="org-src-container"><pre class="src src-lua" id="nil-4"><span class="org-keyword">local</span> <span class="org-variable-name">GitFake</span> = {}

<span class="org-comment-delimiter">-- </span><span class="org-comment">The return format is a list of tables where each element is a {input="..."",</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">output={...kvs...}}.</span>
<span class="org-keyword">function</span> <span class="org-function-name">diff_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Some file changed.</span>
      input = <span class="org-string">" 1 file changed, 35 insertions(+)"</span>
      output[<span class="org-string">"unstaged_files"</span>] = 1
      output[<span class="org-string">"unstaged_insertions"</span>] = 35
      output[<span class="org-string">"unstaged_deletions"</span>] = 0
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Some file was changed again.</span>
      input = <span class="org-string">" 1 file changed, 32 insertions(+), 2 deletions(-)"</span>
      output[<span class="org-string">"unstaged_files"</span>] = 1
      output[<span class="org-string">"unstaged_insertions"</span>] = 32
      output[<span class="org-string">"unstaged_deletions"</span>] = 2
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">diff_cached_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Some file changed.</span>
      input = <span class="org-string">" 2 files changed, 4 insertions(+)"</span>
      output[<span class="org-string">"staged_files"</span>] = 2
      output[<span class="org-string">"staged_insertions"</span>] = 4
      output[<span class="org-string">"staged_deletions"</span>] = 0
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Some file was changed again.</span>
      input = <span class="org-string">" 2 files changed, 4 insertions(+), 8 deletions(-)"</span>
      output[<span class="org-string">"staged_files"</span>] = 2
      output[<span class="org-string">"staged_insertions"</span>] = 4
      output[<span class="org-string">"staged_deletions"</span>] = 8
    <span class="org-keyword">else</span>
      output[<span class="org-string">"staged_files"</span>] = 0
      output[<span class="org-string">"staged_insertions"</span>] = 0
      output[<span class="org-string">"staged_deletions"</span>] = 0
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">diff_binary_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">No binary files changed.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">5   1   doc/build-literate.org</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"unstaged_files_binary"</span>] = 0
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">One binary file changed.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">5   1   doc/build-literate.org</span>
<span class="org-string">-   -   doc/melby.html</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"unstaged_files_binary"</span>] = 1
    <span class="org-keyword">else</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Two binary files changed.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">5   1   doc/build-literate.org</span>
<span class="org-string">-   -   doc/melby.html</span>
<span class="org-string">-   -   foo</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"unstaged_files_binary"</span>] = 2
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">diff_cached_binary_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">One binary file changed.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">5   1   apple</span>
<span class="org-string">-   -   foo</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"staged_files_binary"</span>] = 1
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">No binary files changed.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">5   1   apple</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"staged_files_binary"</span>] = 0
    <span class="org-keyword">else</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Three binary files changed.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">5   1   apple</span>
<span class="org-string">-   -   foo</span>
<span class="org-string">-   -   bar</span>
<span class="org-string">-   -   baz</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"staged_files_binary"</span>] = 3
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">staged_bytes_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">No staged bytes.</span>
      input = <span class="org-string">"0"</span>
      output[<span class="org-string">"staged_bytes"</span>] = 0
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      input = <span class="org-string">"12"</span>
      output[<span class="org-string">"staged_bytes"</span>] = 12
    <span class="org-keyword">else</span>
      input = <span class="org-string">"500"</span>
      output[<span class="org-string">"staged_bytes"</span>] = 500
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">head_metadata_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    input = <span class="org-string">[[</span>
<span class="org-string">head_author_date,1678169218</span>
<span class="org-string">head_author_name,Foo Bar</span>
<span class="org-string">head_committer_date,1678169218</span>
<span class="org-string">head_committer_name,Foo Bar</span>
<span class="org-string">]]</span>
    output[<span class="org-string">"head_author_date"</span>] = 1678169218
    output[<span class="org-string">"head_author_name"</span>] = <span class="org-string">"Foo Bar"</span>
    output[<span class="org-string">"head_committer_date"</span>] = 1678169218
    output[<span class="org-string">"head_committer_name"</span>] = <span class="org-string">"Foo Bar"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">untracked_files_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    input = <span class="org-string">[[</span>
<span class="org-string">file1</span>
<span class="org-string">]]</span>
    output[<span class="org-string">"untracked_files"</span>] = 1
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">assume_unchanged_files_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      input = <span class="org-string">[[</span>
<span class="org-string">H apple</span>
<span class="org-string">h carrot</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"assume_unchanged_files"</span>] = 1
    <span class="org-keyword">else</span>
      input = <span class="org-string">[[</span>
<span class="org-string">H apple</span>
<span class="org-string">H carrot</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"assume_unchanged_files"</span>] = 0
    <span class="org-keyword">end</span>
  <span class="org-keyword">else</span>
    input = <span class="org-string">[[</span>
<span class="org-string">H f1</span>
<span class="org-string">]]</span>
    output[<span class="org-string">"assume_unchanged_files"</span>] = 0
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">count_head_vs_upstream_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      input = <span class="org-string">[[</span>
<span class="org-string">0   0</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"count_upstream_to_head"</span>] = 0
      output[<span class="org-string">"count_head_to_upstream"</span>] = 0
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">We created a commit.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">1   0</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"count_upstream_to_head"</span>] = 1
      output[<span class="org-string">"count_head_to_upstream"</span>] = 0
    <span class="org-keyword">else</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Upstream has moved on (our local branch has diverged).</span>
      input = <span class="org-string">[[</span>
<span class="org-string">1   1</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"count_upstream_to_head"</span>] = 1
      output[<span class="org-string">"count_head_to_upstream"</span>] = 1
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">head_branch_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    input = <span class="org-string">"main"</span>
    output[<span class="org-string">"head_branch"</span>] = <span class="org-string">"main"</span>
  <span class="org-keyword">else</span>
    input = <span class="org-string">"dev"</span>
    output[<span class="org-string">"head_branch"</span>] = <span class="org-string">"dev"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">head_sha_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    input = <span class="org-string">"2bf048d6364fff6f80d0f96f11447a80859f0df7"</span>
    output[<span class="org-string">"head_sha"</span>] = <span class="org-string">"2bf048d6364fff6f80d0f96f11447a80859f0df7"</span>
  <span class="org-keyword">else</span>
    input = <span class="org-string">"6ef4740cfe770f68af432fa27e0dc693dab8fce5"</span>
    output[<span class="org-string">"head_sha"</span>] = <span class="org-string">"6ef4740cfe770f68af432fa27e0dc693dab8fce5"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">bare_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  input = <span class="org-string">"false"</span>
  output[<span class="org-string">"bare"</span>] = <span class="org-constant">false</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">stash_size_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      output[<span class="org-string">"stash_size"</span>] = 0
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      output[<span class="org-string">"stash_size"</span>] = 0
    <span class="org-keyword">else</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Stashed some changes.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">stash@{0}: WIP on main: 6ef4740 update</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"stash_size"</span>] = 1
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">submodule_status_fake</span>(<span class="org-variable-name">pwd</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> pwd == <span class="org-string">"/repo/a"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Nothing initialized.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">-e827a9f3e2ba585de8b07cd246534a15ec414a8b deps/elisp/compat.el (28.1.2.2-7-ge827a9f)</span>
<span class="org-string">-0ac1ecf6b56eb67bb81a3cf70f8d4354b5782341 deps/elisp/dash.el (2.19.1-20-g0ac1ecf)</span>
<span class="org-string">-d495ed87a9c507f5939a51c740f119950c83e2ff deps/elisp/emacs-elixir (v2.3.1-135-gd495ed8)</span>
<span class="org-string">-dd27bc3f26efd728f2b1f01f9e4ac4f61f2ffbf9 deps/elisp/emacs-htmlize (release/1.56-1-gdd27bc3)</span>
<span class="org-string">-90503413f4cdb0ed26871e39c4e6e2552b57f7db deps/elisp/haskell-mode (v13.14-1398-g9050341)</span>
<span class="org-string">-d17a00ca50aee197cd017d573b83367eb241cc44 deps/elisp/lua-mode (v20210802-4-gd17a00c)</span>
<span class="org-string">-8158b484ae32d334c9db60b265759d22547ea952 deps/elisp/magit (v3.3.0-462-g8158b484)</span>
<span class="org-string">-34d51e2731408b5b615f785a83faa3d6dc2a92a1 deps/elisp/nix-mode (v1.4.1-194-g34d51e2)</span>
<span class="org-string">-061cfc002ff6ea41c622447bec22f49d618c36de deps/elisp/org-html-themify (heads/master)</span>
<span class="org-string">-f6e284f8e5dd557fde52241546a916c2e50f0d23 deps/elisp/protobuf (v3.21.6-629-gf6e284f8e)</span>
<span class="org-string">-b4537b6f5fa65626c1bab944681b35769cab9b5c deps/elisp/rust-mode (1.0.5-18-gb4537b6)</span>
<span class="org-string">-e957dcb0677da18b2bb60ad867db5df5c35b5616 deps/elisp/s.el (1.12.0-71-ge957dcb)</span>
<span class="org-string">-535800fd6ca7f5af56f7aa3d0e8f46fef8b7999b deps/elisp/themes (v2.3.0-8-g535800f)</span>
<span class="org-string">-3fcb36d6039bef57e2a0f6e24c51f623c0bf5fb7 deps/elisp/yaml-mode (release-0.0.6-132-g3fcb36d)</span>
<span class="org-string">-d8cf56bb1fa0280fe5b1a2b335dd6637f1964851 deps/misc/org-html-themes (v1.0.2-88-gd8cf56b)</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"submodule_uninitialized"</span>] = 15
      output[<span class="org-string">"submodule_out_of_sync"</span>] = 0
      output[<span class="org-string">"submodule_merge_conflicts"</span>] = 0
    <span class="org-keyword">else</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Everything has initialized.</span>
      input = <span class="org-string">[[</span>
<span class="org-string"> e827a9f3e2ba585de8b07cd246534a15ec414a8b deps/elisp/compat.el (28.1.2.2-7-ge827a9f)</span>
<span class="org-string"> 0ac1ecf6b56eb67bb81a3cf70f8d4354b5782341 deps/elisp/dash.el (2.19.1-20-g0ac1ecf)</span>
<span class="org-string"> d495ed87a9c507f5939a51c740f119950c83e2ff deps/elisp/emacs-elixir (v2.3.1-135-gd495ed8)</span>
<span class="org-string"> dd27bc3f26efd728f2b1f01f9e4ac4f61f2ffbf9 deps/elisp/emacs-htmlize (release/1.56-1-gdd27bc3)</span>
<span class="org-string"> 90503413f4cdb0ed26871e39c4e6e2552b57f7db deps/elisp/haskell-mode (v13.14-1398-g9050341)</span>
<span class="org-string"> d17a00ca50aee197cd017d573b83367eb241cc44 deps/elisp/lua-mode (v20210802-4-gd17a00c)</span>
<span class="org-string"> 8158b484ae32d334c9db60b265759d22547ea952 deps/elisp/magit (v3.3.0-462-g8158b484)</span>
<span class="org-string"> 34d51e2731408b5b615f785a83faa3d6dc2a92a1 deps/elisp/nix-mode (v1.4.1-194-g34d51e2)</span>
<span class="org-string"> 061cfc002ff6ea41c622447bec22f49d618c36de deps/elisp/org-html-themify (heads/master)</span>
<span class="org-string"> f6e284f8e5dd557fde52241546a916c2e50f0d23 deps/elisp/protobuf (v3.21.6-629-gf6e284f8e)</span>
<span class="org-string"> b4537b6f5fa65626c1bab944681b35769cab9b5c deps/elisp/rust-mode (1.0.5-18-gb4537b6)</span>
<span class="org-string"> e957dcb0677da18b2bb60ad867db5df5c35b5616 deps/elisp/s.el (1.12.0-71-ge957dcb)</span>
<span class="org-string"> 535800fd6ca7f5af56f7aa3d0e8f46fef8b7999b deps/elisp/themes (v2.3.0-8-g535800f)</span>
<span class="org-string"> 3fcb36d6039bef57e2a0f6e24c51f623c0bf5fb7 deps/elisp/yaml-mode (release-0.0.6-132-g3fcb36d)</span>
<span class="org-string"> d8cf56bb1fa0280fe5b1a2b335dd6637f1964851 deps/misc/org-html-themes (v1.0.2-88-gd8cf56b)</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"submodule_uninitialized"</span>] = 0
      output[<span class="org-string">"submodule_out_of_sync"</span>] = 0
      output[<span class="org-string">"submodule_merge_conflicts"</span>] = 0
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Note that this invokes the fake readers when it is called, so the values in</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">the table are already the generated {input=..., output=...} tables. This is</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">slightly different than the real readers where the caller still needs to run</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">System.cmd to generate the read results by shelling out.</span>
<span class="org-keyword">function</span> <span class="org-function-name">GitFake.readers</span> (<span class="org-variable-name">resource_opts</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">pwd</span> = resource_opts[<span class="org-string">"PWD"</span>]
  <span class="org-keyword">return</span> {
    diff = diff_fake(pwd, time_idx),
    diff_cached = diff_cached_fake(pwd, time_idx),
    diff_binary = diff_binary_fake(pwd, time_idx),
    diff_cached_binary = diff_cached_binary_fake(pwd, time_idx),
    staged_bytes = staged_bytes_fake(pwd, time_idx),
    head_metadata = head_metadata_fake(pwd, time_idx),
    untracked_files = untracked_files_fake(pwd, time_idx),
    assume_unchanged_files = assume_unchanged_files_fake(pwd, time_idx),
    count_head_vs_upstream = count_head_vs_upstream_fake(pwd, time_idx),
    head_branch = head_branch_fake(pwd, time_idx),
    head_sha = head_sha_fake(pwd, time_idx),
    bare = bare_fake(pwd, time_idx),
    stash_size = stash_size_fake(pwd, time_idx),
    submodule_status = submodule_status_fake(pwd, time_idx),
  }
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">GitFake.resource_id_func</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">pwd</span> = resource_opts[<span class="org-string">"PWD"</span>]

  <span class="org-keyword">if</span> <span class="org-builtin">string</span>.<span class="org-builtin">find</span>(pwd, <span class="org-string">"/repo/a"</span>) <span class="org-keyword">then</span>
    <span class="org-keyword">return</span> <span class="org-string">"/repo/a"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> <span class="org-string">""</span>
<span class="org-keyword">end</span>

<span class="org-keyword">return</span> GitFake
</pre></div>
</div>
</div>
</div>

<div id="outline-container-h-Kubernetes---kubectl-" class="outline-3">
<h3 id="h-Kubernetes---kubectl-"><span class="section-number-3">2.3.</span> Kubernetes (<code>kubectl</code>)</h3>
<div class="outline-text-3" id="text-h-Kubernetes---kubectl-">
<p>
This standard resource model is based on the Git one. Like Git, it uses an
underlying CLI program (<code>kubectl</code>) to read information.
</p>

<p>
However, there are some differences with Git. Every local Git repo is tied to
the path on the filesystem, and we display Git information whenever the shell
visits the path (or a subpath) of the repo. But for Kubernetes, the current path
of the shell doesn't mean anything because we are talking about connections over
the network. Instead, the current <code>KUBECONFIG</code> environment variable determines
any special precedence rules for looking up Kubernetes contexts (similar to how
<code>PATH</code> is used for looking up a binary). Different shell processes may override
this <code>KUBECONFIG</code> variable.
</p>

<p>
In a sense, <code>KUBECONFIG</code> is like <code>PWD</code> because if it changes (or if the files
that the <code>KUBECONFIG</code> point to changes), it affects how <code>kubectl</code> will behave by
default. For example, <code>kubectl config get-contexts</code> will only consider those
contexts discoverable from <code>KUBECONFIG</code>. If <code>KUBECONFIG</code> is not set, <code>kubectl</code>
will pretend that it is set to <code>$HOME/.kube/config</code>.
</p>

<p>
There are 2 types of information we want to retrieve:
</p>

<ol class="org-ol">
<li>The current Kubernetes context (and namespace) via <code>kubectl config
   current-context</code> (to get the current context) and <code>kubectl config
   get-contexts</code> (to get the associated non-default namespace for this context,
if any).</li>
<li>Cluster health information for those contexts described in
<code>MELBY_KUBE_CONTEXTS</code>.</li>
</ol>

<p>
We assume that <code>MELBY_KUBE_CONTEXTS</code> only points to contexts that could be
reached by looking at <code>KUBECONFIG</code> (that these environment variables move in
lockstep).
</p>

<p>
We use a dedicated <code>KubeCurrent.lua</code> for getting the current context and
namespace, and a separate <code>Kube.lua</code> for reading cluster health for
<code>MELBY_KUBE_CONTEXTS</code>.
</p>

<p>
For <code>KubeCurrent.lua</code>, we use <code>KUBECONFIG</code> as our <code>resource_id</code> (for purposes of
<code>resource_id_command</code>). Any time any of the files pointed by <code>KUBECONFIG</code>
changes (filesystem watch), we mark the resource as stale and refresh our
current context/namespace information. FIXME: Test this by changing the config
file with vim on disk to point to a different namespace (and see it reflected in
our prompt).
</p>

<p>
For <code>Kube.lua</code>, we just read per-cluster information (pod availability, uptime,
etc) for <i>a single context</i>. The <code>resource_id</code> is the context name (IMPORTANT:
users should use globally unique context names). Then the user will loop through
each of the contexts found in <code>MELBY_KUBE_CONTEXTS</code> and run <code>Kube.read()</code> to get
this per-cluster information.
</p>
</div>

<div id="outline-container-h-Things-we-have-to-implement" class="outline-4">
<h4 id="h-Things-we-have-to-implement"><span class="section-number-4">2.3.1.</span> Things we have to implement</h4>
<div class="outline-text-4" id="text-h-Things-we-have-to-implement">
</div>
<div id="outline-container-h-IN-PROGRESS-SRS--create-time-based-staleness-flagger--easy" class="outline-5">
<h5 id="h-IN-PROGRESS-SRS--create-time-based-staleness-flagger--easy"><span class="section-number-5">2.3.1.1.</span> IN-PROGRESS SRS: create time-based staleness flagger (easy)</h5>
<div class="outline-text-5" id="text-h-IN-PROGRESS-SRS--create-time-based-staleness-flagger--easy">
</div>
</div>
<div id="outline-container-h-SRS--create-a-command-timeout-for-shell-commands-that-take-too-long-or-error-out" class="outline-5">
<h5 id="h-SRS--create-a-command-timeout-for-shell-commands-that-take-too-long-or-error-out"><span class="section-number-5">2.3.1.2.</span> <span class="todo TODO">TODO</span> SRS: create a command timeout for shell commands that take too long or error out</h5>
<div class="outline-text-5" id="text-h-SRS--create-a-command-timeout-for-shell-commands-that-take-too-long-or-error-out">
<p>
We should let users configure each command with an optional timeout and/or error
reponse detector, such that:
</p>

<ul class="org-ul">
<li>if a command times out (still is running after waiting N seconds), we cancel
it and generate a message for SLG telling the user that a command timed out
<ul class="org-ul">
<li>this should catch cases where kubectl or gcloud return nothing due to either
network connectivity issues (wifi missing) or missing authentication (didn't
run <code>gcloud auth print-access-token</code> yet)</li>
<li>when the user sees the message about the command(s) misbehaving, they can
run something that will (e.g.) reset their auth credentials so that the
commands can work again</li>
</ul></li>
<li>if a command errors out (and we expect it to succeed), we mark a subset of the
entire data we read as "stale" &#x2026; ?</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-h-Implementation-for--KubeCurrent-lua---get-current-context-namespace" class="outline-4">
<h4 id="h-Implementation-for--KubeCurrent-lua---get-current-context-namespace"><span class="section-number-4">2.3.2.</span> Implementation for <code>KubeCurrent.lua</code> (get current context/namespace)</h4>
<div class="outline-text-4" id="text-h-Implementation-for--KubeCurrent-lua---get-current-context-namespace">
<div class="org-src-container"><pre class="src src-lua" id="nil-5"><span class="org-keyword">local</span> <span class="org-variable-name">KubeCurrent</span> = {}
KubeCurrent[<span class="org-string">"type"</span>] = <span class="org-string">"KubeCurrent"</span>
KubeCurrent[<span class="org-string">"history_size"</span>] = 10
KubeCurrent[<span class="org-string">"parser"</span>] = {}
KubeCurrent[<span class="org-string">"fake"</span>] = <span class="org-builtin">require</span> <span class="org-string">"KubeCurrentFake"</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">We need KUBECONFIG and HOME.</span>
<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.read</span> (<span class="org-builtin">self</span>, <span class="org-variable-name">env</span>, <span class="org-variable-name">var_names</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">resource_opts</span> = {}
  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">var_name</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(var_names) <span class="org-keyword">do</span>
    resource_opts[var_name] = env[var_name]
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> melbyd.read_standard_resource(<span class="org-builtin">self</span>, resource_opts)
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">We treat the KUBECONFIG value (after we've done any expansions of variables</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">such as HOME) as the resource_id.</span>
<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.resource_id_func</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">s</span> = resource_opts[<span class="org-string">"KUBECONFIG"</span>]
  <span class="org-comment-delimiter">-- </span><span class="org-comment">If it's, empty, use "$HOME/.kube/config" as the default.</span>
  <span class="org-keyword">if</span> s == <span class="org-constant">nil</span> <span class="org-keyword">or</span> s == <span class="org-string">""</span> <span class="org-keyword">then</span>
    s = resource_opts[<span class="org-string">"HOME"</span>] .. <span class="org-string">"/.kube/config"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> s
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.readers</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">return</span> {{invocation={<span class="org-string">"kubectl"</span>, <span class="org-string">"config"</span>, <span class="org-string">"get-contexts"</span>},
           parser=<span class="org-string">"current_context_and_namespace"</span>,
           env={KUBECONFIG=resource_opts[<span class="org-string">"KUBECONFIG"</span>]}}}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.staleness_flaggers</span> (<span class="org-variable-name">resource_id</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">kubeconfig</span> = resource_id
  <span class="org-keyword">local</span> <span class="org-variable-name">filesystem</span> = {}
  filesystem[<span class="org-string">"type"</span>] = <span class="org-string">"filesystem"</span>
  filesystem[<span class="org-string">"watch_paths"</span>] = melbyd.split(kubeconfig, <span class="org-string">":"</span>)

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Unilke for Git, we watch file paths directly (those specified in</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">KUBECONFIG). We treat all events as "staleness flagging", and thus</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">unconditionally return "true" here.</span>
  filesystem[<span class="org-string">"fs_event_handler"</span>] = <span class="org-keyword">function</span> (<span class="org-variable-name">path</span>, <span class="org-variable-name">events</span>)
    <span class="org-keyword">return</span> <span class="org-constant">true</span>
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">We can technically have multiple staleness flaggers.</span>
  <span class="org-keyword">return</span> {filesystem}
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Split by newline, then for each line: split by whitespace to get all words.</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">then check that the first word is a "*" and use the 2nd word for the context</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">and 5th word for the namespace (if empty, use 'default')</span>
<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.parser.current_context_and_namespace</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}

  <span class="org-keyword">local</span> <span class="org-variable-name">words</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">lines</span> = melbyd.get_lines_trimmed_nonempty(s)
  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">line</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(lines) <span class="org-keyword">do</span>

    <span class="org-comment-delimiter">-- </span><span class="org-comment">NOTE: gmatch is not implemented in luerl; see</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">https://github.com/rvirding/luerl/issues/150. So instead we have to call</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">out to Elixir again.</span>
    words = melbyd.split(line, <span class="org-string">" "</span>)

    <span class="org-keyword">if</span> (words[1] <span class="org-keyword">or</span> <span class="org-string">""</span>) == <span class="org-string">"*"</span> <span class="org-keyword">then</span>
      <span class="org-keyword">local</span> <span class="org-variable-name">context</span> = words[2]
      <span class="org-keyword">local</span> <span class="org-variable-name">namespace</span> = words[5]
      <span class="org-keyword">if</span> context == <span class="org-constant">nil</span> <span class="org-keyword">or</span> context == <span class="org-string">""</span> <span class="org-keyword">then</span>
        <span class="org-keyword">break</span>
      <span class="org-keyword">end</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Technically the `namespace` here will never be the empty string because</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">we only matched (of at least 1 character) some number of non-whitespace</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">characters, or we didn't and namespace (words[5]) is simply nil.</span>
      <span class="org-keyword">if</span> namespace == <span class="org-constant">nil</span> <span class="org-keyword">or</span> namespace == <span class="org-string">""</span> <span class="org-keyword">then</span>
        namespace = <span class="org-string">"default"</span>
      <span class="org-keyword">end</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Happy path.</span>
      ret[<span class="org-string">"context"</span>] = context
      ret[<span class="org-string">"namespace"</span>] = namespace
      <span class="org-keyword">return</span> ret
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Write safe defaults to make comparisons less painful in the main Lua config.</span>
  melbyd.log(<span class="org-string">"KubeCurrent returned empty string; using empty strings as defaults"</span>)
  ret[<span class="org-string">"context"</span>] = <span class="org-string">""</span>
  ret[<span class="org-string">"namespace"</span>] = <span class="org-string">""</span>
  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.notify</span> (<span class="org-variable-name">resource_id</span>, <span class="org-variable-name">old</span>, <span class="org-variable-name">new</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">kubeconfig</span> = resource_id
  <span class="org-keyword">local</span> <span class="org-variable-name">message</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Generate a new message if we change the current context or namespace.</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">old_context</span> = old.kvs.context
  <span class="org-keyword">local</span> <span class="org-variable-name">new_context</span> = new.kvs.context

  <span class="org-keyword">local</span> <span class="org-variable-name">old_namespace</span> = old.kvs.namespace
  <span class="org-keyword">local</span> <span class="org-variable-name">new_namespace</span> = new.kvs.namespace

  <span class="org-keyword">if</span> new_context ~= old_context <span class="org-keyword">then</span>
    message[<span class="org-string">"topic"</span>]=<span class="org-string">"srs_KubeCurrent"</span>
    message[<span class="org-string">"from"</span>]=kubeconfig
    message[<span class="org-string">"payload"</span>]={level=<span class="org-string">"info"</span>,
                        text=<span class="org-string">"Context changed from '"</span> ..
                          old_context .. <span class="org-string">"' to '"</span> ..
                          new_context .. <span class="org-string">"'."</span>}
    melbyd.broadcast(<span class="org-string">"srs_KubeCurrent"</span>, message)
  <span class="org-keyword">end</span>

  <span class="org-keyword">if</span> new_namespace ~= old_namespace <span class="org-keyword">then</span>
    message[<span class="org-string">"topic"</span>]=<span class="org-string">"srs_KubeCurrent"</span>
    message[<span class="org-string">"from"</span>]=kubeconfig
    message[<span class="org-string">"payload"</span>]={level=<span class="org-string">"info"</span>,
                        text=<span class="org-string">"Namespace changed from '"</span> ..
                          old_namespace .. <span class="org-string">"' to '"</span> ..
                          new_namespace .. <span class="org-string">"'."</span>}
    melbyd.broadcast(<span class="org-string">"srs_KubeCurrent"</span>, message)
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> <span class="org-constant">nil</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">Only keep messages if the KUBECONFIG of the message "from" matches the</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">KUBECONFIG env var used by the current shell.</span>
<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.should_keep_message</span> (<span class="org-variable-name">message</span>, <span class="org-variable-name">env_vars</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">shell_kubeconfig</span> = env_vars[<span class="org-string">"KUBECONFIG"</span>] <span class="org-keyword">or</span> <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">kubeconfig</span> = message[<span class="org-string">"from"</span>]

  <span class="org-keyword">return</span> shell_kubeconfig == kubeconfig
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.message_to_string</span> (<span class="org-variable-name">message</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">kubeconfig</span> = message[<span class="org-string">"from"</span>]
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"  ["</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"time"</span>] .. <span class="org-string">"]"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"["</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"level"</span>] .. <span class="org-string">"]"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"[ K8s ]"</span>, fg=<span class="org-string">"lightskyblue"</span>, styles={<span class="org-string">"bold"</span>}})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kubeconfig, fg=<span class="org-string">"yellow"</span>, styles={<span class="org-string">"bold"</span>},
                         drop_delim_right=<span class="org-constant">true</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">": "</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"text"</span>]})

  <span class="org-keyword">return</span> melbyd.render(widgets, {str=<span class="org-string">" "</span>})
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Allow a "substrs" argument here to pull in the already-rendered</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">cluster health info, so that it is inside the closing brace at the end (also</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">adjust asterisk accordingly to be there if we're loading either the</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">KubeCurrent OR Kube standard resource statuses)</span>
<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrent.view</span> (<span class="org-variable-name">standard_resource</span>, <span class="org-variable-name">health_resource_status</span>, <span class="org-variable-name">health_str</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">kubecurrent</span> = standard_resource[<span class="org-string">"kvs"</span>]

  <span class="org-keyword">if</span> standard_resource.status == <span class="org-string">"STANDARD_RESOURCE_STATUS_LOADING"</span> <span class="org-keyword">and</span>
    (<span class="org-builtin">next</span>(kubecurrent) == <span class="org-constant">nil</span>) <span class="org-keyword">then</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"[ K8s... ]"</span>})
  <span class="org-keyword">elseif</span> kubecurrent.context ~= <span class="org-string">""</span> <span class="org-keyword">and</span> kubecurrent.namespace ~= <span class="org-string">""</span> <span class="org-keyword">then</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"["</span>, drop_delim_right=<span class="org-constant">true</span>})
    <span class="org-comment-delimiter">-- </span><span class="org-comment">utf8.char(9096) is "&#9096;"</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-builtin">utf8</span>.<span class="org-builtin">char</span>(9096), fg=<span class="org-string">"lightskyblue"</span>,
                           styles={<span class="org-string">"bold"</span>}})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kubecurrent.context, fg=<span class="org-string">"lightskyblue"</span>,
                           styles={<span class="org-string">"bold"</span>}, drop_delim_right=<span class="org-constant">true</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">":"</span>, drop_delim_right=<span class="org-constant">true</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kubecurrent.namespace, fg=<span class="org-string">"lightsalmon"</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=health_str, drop_delim_right=<span class="org-constant">true</span>})
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Append asterisk if Melby is serving stale data.</span>
    <span class="org-keyword">if</span> standard_resource.status == <span class="org-string">"STANDARD_RESOURCE_STATUS_LOADING"</span> <span class="org-keyword">or</span>
      health_resource_status == <span class="org-string">"STANDARD_RESOURCE_STATUS_LOADING"</span> <span class="org-keyword">then</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"]*"</span>, drop_delim_left=<span class="org-constant">true</span>})
    <span class="org-keyword">else</span>
      <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"]"</span>, drop_delim_left=<span class="org-constant">true</span>})
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> widgets
<span class="org-keyword">end</span>

<span class="org-keyword">return</span> KubeCurrent
</pre></div>
</div>

<div id="outline-container-h-Fake-1" class="outline-5">
<h5 id="h-Fake-1"><span class="section-number-5">2.3.2.1.</span> Fake</h5>
<div class="outline-text-5" id="text-h-Fake-1">
<div class="org-src-container"><pre class="src src-lua" id="nil-6"><span class="org-keyword">local</span> <span class="org-variable-name">KubeCurrentFake</span> = {}

<span class="org-comment-delimiter">-- </span><span class="org-comment">We really only use the time_idx because it's simpler here.</span>
<span class="org-keyword">function</span> <span class="org-function-name">current_context_and_namespace_fake</span>(<span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Set to context "one".</span>
    input = <span class="org-string">[[</span>
<span class="org-string">CURRENT   NAME          CLUSTER          AUTHINFO              NAMESPACE</span>
<span class="org-string">*         one           local            cluster-admin         foo</span>
<span class="org-string">          two           two              two                   default</span>
<span class="org-string">]]</span>
    output[<span class="org-string">"context"</span>] = <span class="org-string">"one"</span>
    output[<span class="org-string">"namespace"</span>] = <span class="org-string">"foo"</span>
  <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Change to context "two".</span>
    input = <span class="org-string">[[</span>
<span class="org-string">CURRENT   NAME          CLUSTER          AUTHINFO              NAMESPACE</span>
<span class="org-string">          one           local            cluster-admin         default</span>
<span class="org-string">*         two           two              two                   bar</span>
<span class="org-string">]]</span>
    output[<span class="org-string">"context"</span>] = <span class="org-string">"two"</span>
    output[<span class="org-string">"namespace"</span>] = <span class="org-string">"bar"</span>
  <span class="org-keyword">else</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Change to namespace "default".</span>
    input = <span class="org-string">[[</span>
<span class="org-string">CURRENT   NAME          CLUSTER          AUTHINFO              NAMESPACE</span>
<span class="org-string">          one           local            cluster-admin         default</span>
<span class="org-string">*         two           two              two                   default</span>
<span class="org-string">]]</span>
    output[<span class="org-string">"context"</span>] = <span class="org-string">"two"</span>
    output[<span class="org-string">"namespace"</span>] = <span class="org-string">"default"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrentFake.readers</span> (<span class="org-variable-name">resource_opts</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: The reader is supposed to be auto-invoked whenever the file(s)</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">pointed by KUBECONFIG env var from the client changes (filesystem watch).</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">So we need to send fake filesystem events as part of the validation</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">strategy. Sending a filesystem event is as simple as sending the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">correctly-formed tuple to the SRS process.</span>
  <span class="org-keyword">return</span> {
    current_context_and_namespace =
      current_context_and_namespace_fake(kubeconfig, time_idx)
  }

<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">KubeCurrentFake.resource_id_func</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">return</span> resource_opts[<span class="org-string">"KUBECONFIG"</span>]
<span class="org-keyword">end</span>

<span class="org-keyword">return</span> KubeCurrentFake
</pre></div>
</div>
</div>
</div>

<div id="outline-container-h-Fake--kubectl--for-the-test-environment" class="outline-4">
<h4 id="h-Fake--kubectl--for-the-test-environment"><span class="section-number-4">2.3.3.</span> Fake <code>kubectl</code> for the test environment</h4>
<div class="outline-text-4" id="text-h-Fake--kubectl--for-the-test-environment">
<p>
We use a fake <code>kubectl</code> script and put it in our PATH for our development shell.
This way, we can test how our <code>kubectl</code>-aware Lua configuration will behave
without actually having to deal with real Kubernetes clusters.
</p>

<p>
The asterisks in the script have to be escaped with a comma like <code>,*</code> because of
Org mode.
</p>

<div class="org-src-container"><pre class="src src-sh" id="nil-7"><span class="org-builtin">set</span> -euo pipefail

<span class="org-keyword">if</span> [[ -n <span class="org-string">"${MELBY_WANT_KUBECTL_ERROR:-}"</span> ]]; <span class="org-keyword">then</span>
    sleep 5
    <span class="org-keyword">exit</span> 1
<span class="org-keyword">fi</span>

<span class="org-variable-name">SCRIPT_ROOT</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">dirname "$(realpath "$0"</span><span class="org-string">)")"</span>

<span class="org-function-name">usage</span>()
{
    &gt;&amp;2 cat &lt;&lt;-EOF
<span class="org-sh-heredoc">    usage:   $0 args...</span>
<span class="org-sh-heredoc">EOF</span>
}

<span class="org-function-name">main</span>()
{
    <span class="org-keyword">if</span> (( $<span class="org-variable-name">#</span> == 0 )); <span class="org-keyword">then</span>
        usage
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>

    <span class="org-builtin">local</span> kubeconfig

    <span class="org-keyword">if</span> [[ -f <span class="org-string">"${KUBECONFIG}"</span> ]]; <span class="org-keyword">then</span>
        <span class="org-variable-name">kubeconfig</span>=<span class="org-string">"${KUBECONFIG}"</span>
    <span class="org-keyword">else</span>
        <span class="org-variable-name">kubeconfig</span>=<span class="org-string">"${SCRIPT_ROOT}/fake_kube_config"</span>
    <span class="org-keyword">fi</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">kubectl config get-contexts</span>
    <span class="org-comment-delimiter">#</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">We use the following format for fake_kube_config:</span>
    <span class="org-comment-delimiter">#</span>
    <span class="org-comment-delimiter">#   </span><span class="org-comment">current-context=one</span>
    <span class="org-comment-delimiter">#   </span><span class="org-comment">current-namespace=foo</span>
    <span class="org-comment-delimiter">#</span>
    <span class="org-keyword">if</span> [[ <span class="org-string">"${1:-}"</span> == config ]] &amp;&amp; [[ <span class="org-string">"${2:-}"</span> == get-contexts ]]; <span class="org-keyword">then</span>
        <span class="org-keyword">if</span> grep -q <span class="org-string">"current-context=one"</span> <span class="org-string">"${kubeconfig}"</span>; <span class="org-keyword">then</span>
            <span class="org-keyword">if</span> grep -q <span class="org-string">"current-namespace=foo"</span> <span class="org-string">"${kubeconfig}"</span>; <span class="org-keyword">then</span>
                cat &lt;&lt;-EOF
<span class="org-sh-heredoc">CURRENT   NAME          CLUSTER          AUTHINFO              NAMESPACE</span>
<span class="org-sh-heredoc">*         one           local            cluster-admin         foo</span>
<span class="org-sh-heredoc">            two           two              two                   default</span>
<span class="org-sh-heredoc">EOF</span>
            <span class="org-keyword">else</span>
                cat &lt;&lt;-EOF
<span class="org-sh-heredoc">CURRENT   NAME          CLUSTER          AUTHINFO              NAMESPACE</span>
<span class="org-sh-heredoc">*         one           local            cluster-admin         default</span>
<span class="org-sh-heredoc">            two           two              two                   default</span>
<span class="org-sh-heredoc">EOF</span>
            <span class="org-keyword">fi</span>
        <span class="org-keyword">else</span>
            <span class="org-keyword">if</span> grep -q <span class="org-string">"current-namespace=bar"</span> <span class="org-string">"${kubeconfig}"</span>; <span class="org-keyword">then</span>
                cat &lt;&lt;-EOF
<span class="org-sh-heredoc">CURRENT   NAME          CLUSTER          AUTHINFO              NAMESPACE</span>
<span class="org-sh-heredoc">            one           local            cluster-admin         default</span>
<span class="org-sh-heredoc">*         two           two              two                   bar</span>
<span class="org-sh-heredoc">EOF</span>
            <span class="org-keyword">else</span>
                cat &lt;&lt;-EOF
<span class="org-sh-heredoc">CURRENT   NAME          CLUSTER          AUTHINFO              NAMESPACE</span>
<span class="org-sh-heredoc">            one           local            cluster-admin         default</span>
<span class="org-sh-heredoc">*         two           two              two                   default</span>
<span class="org-sh-heredoc">EOF</span>
            <span class="org-keyword">fi</span>
        <span class="org-keyword">fi</span>
    <span class="org-keyword">fi</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">We are lazy and don't even bother checking that the 3rd and 4th arguments</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">are of the form "-o" and "go-template-file=...", which this part is</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">simulating.</span>
    <span class="org-keyword">if</span> [[ <span class="org-string">"${1:-}"</span> == get ]] &amp;&amp; [[ <span class="org-string">"${2:-}"</span> == pods ]] ; <span class="org-keyword">then</span>
        <span class="org-builtin">shift</span> 4
        <span class="org-builtin">local</span> context
        <span class="org-builtin">local</span> namespace
        <span class="org-variable-name">context</span>=<span class="org-string">"${1#*=}"</span>
        <span class="org-variable-name">namespace</span>=<span class="org-string">"${2#*=}"</span>
        <span class="org-keyword">if</span> [[ <span class="org-string">"${context}"</span> == one ]]; <span class="org-keyword">then</span>
            <span class="org-comment-delimiter"># </span><span class="org-comment">FIXME: Move these stdout contents to a file, and switch between</span>
            <span class="org-comment-delimiter"># </span><span class="org-comment">them based on a separate "state" file, just like fake_kube_config.</span>
            cat &lt;&lt;-EOF
<span class="org-sh-heredoc">            Pending</span>
<span class="org-sh-heredoc">            Pending</span>
<span class="org-sh-heredoc">            Pending</span>
<span class="org-sh-heredoc">            Pending</span>
<span class="org-sh-heredoc">            Pending</span>
<span class="org-sh-heredoc">            Running</span>
<span class="org-sh-heredoc">            Running</span>
<span class="org-sh-heredoc">            Unknown</span>
<span class="org-sh-heredoc">            EOF</span>
        <span class="org-keyword">else</span>
            cat &lt;&lt;-EOF
<span class="org-sh-heredoc">            Pending</span>
<span class="org-sh-heredoc">            Failed</span>
<span class="org-sh-heredoc">            Failed</span>
<span class="org-sh-heredoc">            Succeeded</span>
<span class="org-sh-heredoc">            EOF</span>
        <span class="org-keyword">fi</span>
    <span class="org-keyword">fi</span>
}

main <span class="org-string">"$@"</span>
</pre></div>
</div>
</div>

<div id="outline-container-h-Implementation-for--Kube-lua---get-per-cluster-information" class="outline-4">
<h4 id="h-Implementation-for--Kube-lua---get-per-cluster-information"><span class="section-number-4">2.3.4.</span> Implementation for <code>Kube.lua</code> (get per-cluster information)</h4>
<div class="outline-text-4" id="text-h-Implementation-for--Kube-lua---get-per-cluster-information">
<div class="org-src-container"><pre class="src src-lua" id="nil-8"><span class="org-keyword">local</span> <span class="org-variable-name">Kube</span> = {}
Kube[<span class="org-string">"type"</span>] = <span class="org-string">"Kube"</span>
Kube[<span class="org-string">"history_size"</span>] = 10
Kube[<span class="org-string">"parser"</span>] = {}
Kube[<span class="org-string">"fake"</span>] = <span class="org-builtin">require</span> <span class="org-string">"KubeFake"</span>

<span class="org-keyword">function</span> <span class="org-function-name">Kube.read</span> (<span class="org-builtin">self</span>, <span class="org-variable-name">context</span>, <span class="org-variable-name">namespace</span>, <span class="org-variable-name">melby_dir</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">resource_opts</span> = {}
  resource_opts[<span class="org-string">"context"</span>] = context
  resource_opts[<span class="org-string">"namespace"</span>] = namespace <span class="org-keyword">or</span> <span class="org-string">"default"</span>
  resource_opts[<span class="org-string">"MELBY_DIR"</span>] = melby_dir

  <span class="org-keyword">return</span> melbyd.read_standard_resource(<span class="org-builtin">self</span>, resource_opts)
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Kube.resource_id_func</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">return</span> resource_opts[<span class="org-string">"context"</span>] .. <span class="org-string">":"</span> .. resource_opts[<span class="org-string">"namespace"</span>]
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Kube.readers</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">context</span> = resource_opts[<span class="org-string">"context"</span>]
  <span class="org-keyword">local</span> <span class="org-variable-name">namespace</span> = resource_opts[<span class="org-string">"namespace"</span>]

  <span class="org-keyword">local</span> <span class="org-variable-name">readers</span> = {
    {invocation={<span class="org-string">"kubectl"</span>, <span class="org-string">"get"</span>, <span class="org-string">"pods"</span>, <span class="org-string">"-o"</span>,
                 <span class="org-string">"go-template-file="</span> ..
                   resource_opts[<span class="org-string">"MELBY_DIR"</span>] ..
                   <span class="org-string">"/get_pods.gotemplate"</span>,
                 <span class="org-string">"--context="</span> .. context,
                 <span class="org-string">"--namespace="</span> .. namespace},
     parser=<span class="org-string">"get_pods"</span>},
  }
  <span class="org-keyword">return</span> readers
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">We use a time-based staleness flagger which marks the model as stale every 2</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">seconds, just like the default setting of the `watch` UNIX command.</span>
<span class="org-keyword">function</span> <span class="org-function-name">Kube.staleness_flaggers</span> (<span class="org-variable-name">repo_root</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">duration</span> = {}
  duration[<span class="org-string">"type"</span>] = <span class="org-string">"duration"</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Mark as stale every 2 seconds (ISO 8601 format).</span>
  duration[<span class="org-string">"duration"</span>] = <span class="org-string">"PT2S"</span>

  <span class="org-keyword">return</span> {duration}
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">This is from the go template.</span>
<span class="org-keyword">function</span> <span class="org-function-name">Kube.parser.get_pods</span> (<span class="org-variable-name">s</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">ret</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Example input strings (format is "PHASE"):</span>
  <span class="org-comment-delimiter">--    </span><span class="org-comment">Running</span>
  <span class="org-comment-delimiter">--    </span><span class="org-comment">Pending</span>

  <span class="org-keyword">local</span> <span class="org-variable-name">phases</span> = melbyd.get_lines_trimmed_nonempty(s)

  <span class="org-comment-delimiter">-- </span><span class="org-comment">How many pods are listed?</span>
  ret[<span class="org-string">"pods"</span>] = #phases

  <span class="org-keyword">local</span> <span class="org-variable-name">count</span> = 0

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Construct mapping of pod phases and the number of pods in that phase.</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">See https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">The 5 possible phase values are: Pending, Running, Succeeded, Failed, Unknown.</span>
  ret[<span class="org-string">"pods_in_phase_Pending"</span>] = 0
  ret[<span class="org-string">"pods_in_phase_Running"</span>] = 0
  ret[<span class="org-string">"pods_in_phase_Succeeded"</span>] = 0
  ret[<span class="org-string">"pods_in_phase_Failed"</span>] = 0
  ret[<span class="org-string">"pods_in_phase_Unknown"</span>] = 0
  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">phase</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(phases) <span class="org-keyword">do</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">The "or 0" here only takes effect if we see an unknown phase. Basically</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">it should never happen.</span>
    count = ret[<span class="org-string">"pods_in_phase_"</span> .. phase] <span class="org-keyword">or</span> 0
    ret[<span class="org-string">"pods_in_phase_"</span> .. phase] = count + 1
  <span class="org-keyword">end</span>

  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Move this to the View section, because we shouldn't store redundant</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">data.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Of the listed pods, how many are in a healthy "Running" phase? This is</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">useful for service clusters where the pods are long-lived services that are</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">expected to always be in a "Running" state (being available).</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">string.format("%.1f%%", p*100) -&gt; "50.0%" for 1/2</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">if #phases == 0 then</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Pending"]   = 0.0</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Running"]   = 0.0</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Succeeded"] = 0.0</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Failed"]    = 0.0</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Unknown"]   = 0.0</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">else</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Pending"]   = ret["pods_in_phase_Pending"]   / #phases</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Running"]   = ret["pods_in_phase_Running"]   / #phases</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Succeeded"] = ret["pods_in_phase_Succeeded"] / #phases</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Failed"]    = ret["pods_in_phase_Failed"]    / #phases</span>
<span class="org-comment-delimiter">--   </span><span class="org-comment">ret["pods_percent_in_phase_Unknown"]   = ret["pods_in_phase_Unknown"]   / #phases</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">end</span>

  <span class="org-keyword">return</span> ret
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Kube.notify</span> (<span class="org-variable-name">resource_id</span>, <span class="org-variable-name">old</span>, <span class="org-variable-name">new</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">context_and_namespace</span> = resource_id
  <span class="org-keyword">local</span> <span class="org-variable-name">message</span> = {}
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Show a diff of all phase buckets. Also output a number of all running pods</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">(as a basic sanity check that N pods are running for some service cluster).</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Something like:</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--    </span><span class="org-comment">Pods: Total 6 (-3), Pending 4 (+1), Running 2 (-4), Succeeded 0, Failed 0, Unknown 0</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Where we display the totals and the difference (vs old state in totals but</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">also as a percentage) in parentheses.</span>

  <span class="org-keyword">local</span> <span class="org-variable-name">diff_found</span> = <span class="org-constant">false</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">delta</span> = {}
  <span class="org-keyword">local</span> <span class="org-function-name">delta_with_sign</span> = <span class="org-keyword">function</span> (<span class="org-variable-name">n</span>)
    <span class="org-keyword">if</span> n &lt; 0 <span class="org-keyword">then</span>
      <span class="org-keyword">return</span> melbyd.render(
        {{str=<span class="org-builtin">tostring</span>(n), fg=<span class="org-string">"red"</span>, styles={<span class="org-string">"bold"</span>}}},
        {str=<span class="org-string">" "</span>})
    <span class="org-keyword">end</span>

    <span class="org-keyword">return</span> melbyd.render(
      {{str=<span class="org-string">"+"</span> .. n, fg=<span class="org-string">"lime"</span>, styles={<span class="org-string">"bold"</span>}}},
      {str=<span class="org-string">" "</span>})
  <span class="org-keyword">end</span>

  <span class="org-keyword">local</span> <span class="org-variable-name">keys</span> = {
    <span class="org-string">"pods"</span>,
    <span class="org-string">"pods_in_phase_Pending"</span>,
    <span class="org-string">"pods_in_phase_Running"</span>,
    <span class="org-string">"pods_in_phase_Succeeded"</span>,
    <span class="org-string">"pods_in_phase_Failed"</span>,
    <span class="org-string">"pods_in_phase_Unknown"</span>,
  }
  <span class="org-keyword">local</span> <span class="org-variable-name">key_display_name</span> = {}
  key_display_name[<span class="org-string">"pods"</span>] = <span class="org-string">"Total"</span>
  key_display_name[<span class="org-string">"pods_in_phase_Pending"</span>] = <span class="org-string">"Pending"</span>
  key_display_name[<span class="org-string">"pods_in_phase_Running"</span>] = <span class="org-string">"Running"</span>
  key_display_name[<span class="org-string">"pods_in_phase_Succeeded"</span>] = <span class="org-string">"Succeeded"</span>
  key_display_name[<span class="org-string">"pods_in_phase_Failed"</span>] = <span class="org-string">"Failed"</span>
  key_display_name[<span class="org-string">"pods_in_phase_Unknown"</span>] = <span class="org-string">"Unknown"</span>

  <span class="org-keyword">for</span> <span class="org-variable-name">_</span>, <span class="org-variable-name">key</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(keys) <span class="org-keyword">do</span>
    <span class="org-keyword">local</span> <span class="org-variable-name">old_val</span> = old.kvs[key]
    <span class="org-keyword">local</span> <span class="org-variable-name">new_val</span> = new.kvs[key]
    delta[key] = new_val - old_val
    diff_found = diff_found <span class="org-keyword">or</span> (old_val ~= new_val)
  <span class="org-keyword">end</span>

  <span class="org-keyword">if</span> diff_found <span class="org-keyword">then</span>
    <span class="org-keyword">local</span> <span class="org-variable-name">text</span> = <span class="org-string">"Pods:"</span>
    <span class="org-keyword">for</span> <span class="org-variable-name">i</span>, <span class="org-variable-name">key</span> <span class="org-keyword">in</span> <span class="org-builtin">ipairs</span>(keys) <span class="org-keyword">do</span>
      <span class="org-keyword">local</span> <span class="org-variable-name">sep</span> = <span class="org-string">", "</span>
      <span class="org-keyword">if</span> i == 1 <span class="org-keyword">then</span>
        sep = <span class="org-string">" "</span>
      <span class="org-keyword">end</span>
      text = text .. sep ..
        <span class="org-builtin">string</span>.<span class="org-builtin">format</span>(<span class="org-string">"%s %d"</span>, key_display_name[key], new.kvs[key])
      <span class="org-keyword">if</span> delta[key] ~= 0 <span class="org-keyword">then</span>
        text = text .. <span class="org-builtin">string</span>.<span class="org-builtin">format</span>(<span class="org-string">" (%s)"</span>, delta_with_sign(delta[key]))
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
    message[<span class="org-string">"topic"</span>]=<span class="org-string">"srs_Kube"</span>
    message[<span class="org-string">"from"</span>]=context_and_namespace
    message[<span class="org-string">"payload"</span>]={level=<span class="org-string">"info"</span>, text=text}
    melbyd.broadcast(<span class="org-string">"srs_Kube"</span>, message)
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> <span class="org-constant">nil</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">This resource is generally meant for detecting cluster health (pod stats), so</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">it's conceivable that all shells would like to know about this. So we just</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">always return "true".</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Is there a better default for this?</span>
<span class="org-keyword">function</span> <span class="org-function-name">Kube.should_keep_message</span> (<span class="org-variable-name">message</span>, <span class="org-variable-name">env_vars</span>)
  <span class="org-keyword">return</span> <span class="org-constant">true</span>
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Kube.message_to_string</span> (<span class="org-variable-name">message</span>, <span class="org-variable-name">pwd_pretty_options</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">context_and_namespace_array</span> = melbyd.split(message[<span class="org-string">"from"</span>], <span class="org-string">":"</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">context</span> = context_and_namespace_array[1]
  <span class="org-keyword">local</span> <span class="org-variable-name">namespace</span> = context_and_namespace_array[2]
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"  ["</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"time"</span>] .. <span class="org-string">"]"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"["</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"level"</span>] .. <span class="org-string">"]"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"[ K8s (Cluster Health) ]"</span>, fg=<span class="org-string">"lightskyblue"</span>,
                         styles={<span class="org-string">"bold"</span>}})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=context, drop_delim_right=<span class="org-constant">true</span>, fg=<span class="org-string">"lightskyblue"</span>,
                         styles={<span class="org-string">"bold"</span>}})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">":"</span>, drop_delim_right=<span class="org-constant">true</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=namespace, drop_delim_right=<span class="org-constant">true</span>, fg=<span class="org-string">"lightsalmon"</span>})
  <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">": "</span> .. message[<span class="org-string">"payload"</span>][<span class="org-string">"text"</span>]})

  <span class="org-keyword">return</span> melbyd.render(widgets, {str=<span class="org-string">" "</span>})
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">Kube.view</span> (<span class="org-variable-name">standard_resource</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">widgets</span> = {}
  <span class="org-keyword">local</span> <span class="org-variable-name">kube</span> = standard_resource[<span class="org-string">"kvs"</span>]

  <span class="org-comment-delimiter">-- </span><span class="org-comment">Display pod information in a compact way.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">Example:</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">--    </span><span class="org-comment">10T 1p 5r 1s 2f 0u</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">for 10 total pods, 1 pending, 5 running, 1 succeeded, 2 failed, 0 unknown.</span>
  <span class="org-comment-delimiter">--</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">FIXME: Display percentages instead of raw pod counts. We already get raw</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">pod counts in the messaging part.</span>
  <span class="org-keyword">if</span> standard_resource.status == <span class="org-string">"STANDARD_RESOURCE_STATUS_LOADING"</span> <span class="org-keyword">and</span>
    (<span class="org-builtin">next</span>(kube) == <span class="org-constant">nil</span>) <span class="org-keyword">then</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=<span class="org-string">"(pods...)"</span>})
  <span class="org-keyword">elseif</span> kube.pods ~= <span class="org-constant">nil</span> <span class="org-keyword">then</span>
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kube.pods .. <span class="org-string">"T"</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kube.pods_in_phase_Pending .. <span class="org-string">"p"</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kube.pods_in_phase_Running .. <span class="org-string">"r"</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kube.pods_in_phase_Succeeded .. <span class="org-string">"s"</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kube.pods_in_phase_Failed .. <span class="org-string">"f"</span>})
    <span class="org-builtin">table</span>.<span class="org-builtin">insert</span>(widgets, {str=kube.pods_in_phase_Unknown .. <span class="org-string">"u"</span>})
    <span class="org-comment-delimiter">-- </span><span class="org-comment">Unlike for Git, we don't append an asterisk if we are serving "stale"</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">data because technically the data is always stale and it is constantly</span>
    <span class="org-comment-delimiter">-- </span><span class="org-comment">refreshed.</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> widgets
<span class="org-keyword">end</span>

<span class="org-keyword">return</span> Kube
</pre></div><p>
This is the template for the "get_pods" reader. Format is just "&lt;STATUS&gt;".
</p>

<div class="org-src-container"><pre class="src src-text" id="nil-9">{{- range .items -}}
{{.status.phase}}{{"\n"}}
{{- end -}}
</pre></div>
</div>

<div id="outline-container-h-Fake-2" class="outline-5">
<h5 id="h-Fake-2"><span class="section-number-5">2.3.4.1.</span> Fake</h5>
<div class="outline-text-5" id="text-h-Fake-2">
<div class="org-src-container"><pre class="src src-lua" id="nil-10"><span class="org-keyword">local</span> <span class="org-variable-name">KubeFake</span> = {}

<span class="org-comment-delimiter">-- </span><span class="org-comment">time_idx is a point in time. It captures the idea of running this function</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">multiple times. If we want to always return the same result, we can ignore</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">the time_idx. But if we want to return certain values in a particular order,</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">we can use this time_idx, where 0 means the first time this function is</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">called, 1 is the next time, and so on. The time_idx will always wrap back to</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">0 after reaching FIXME (max time_idx value).</span>
<span class="org-keyword">function</span> <span class="org-function-name">get_pods_fake</span>(<span class="org-variable-name">context</span>, <span class="org-variable-name">namespace</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">input</span> = <span class="org-string">""</span>
  <span class="org-keyword">local</span> <span class="org-variable-name">output</span> = {}

  <span class="org-keyword">if</span> context == <span class="org-string">"one"</span> <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      input = <span class="org-string">[[</span>
<span class="org-string">Pending</span>
<span class="org-string">Pending</span>
<span class="org-string">Pending</span>
<span class="org-string">Pending</span>
<span class="org-string">Pending</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Unknown</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"pods"</span>] = 8
      output[<span class="org-string">"pods_in_phase_Pending"</span>] = 5
      output[<span class="org-string">"pods_in_phase_Running"</span>] = 2
      output[<span class="org-string">"pods_in_phase_Succeeded"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Failed"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Unknown"</span>] = 1
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">More things have started running.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Unknown</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"pods"</span>] = 8
      output[<span class="org-string">"pods_in_phase_Pending"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Running"</span>] = 7
      output[<span class="org-string">"pods_in_phase_Succeeded"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Failed"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Unknown"</span>] = 1
    <span class="org-keyword">else</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">Everything is running OK (including the previously unknown one)!</span>
      input = <span class="org-string">[[</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">Running</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"pods"</span>] = 8
      output[<span class="org-string">"pods_in_phase_Pending"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Running"</span>] = 8
      output[<span class="org-string">"pods_in_phase_Succeeded"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Failed"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Unknown"</span>] = 0
    <span class="org-keyword">end</span>
  <span class="org-keyword">else</span>
    <span class="org-keyword">if</span> time_idx == 0 <span class="org-keyword">then</span>
      input = <span class="org-string">[[</span>
<span class="org-string">Pending</span>
<span class="org-string">Failed</span>
<span class="org-string">Failed</span>
<span class="org-string">Succeeded</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"pods"</span>] = 4
      output[<span class="org-string">"pods_in_phase_Pending"</span>] = 1
      output[<span class="org-string">"pods_in_phase_Running"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Succeeded"</span>] = 1
      output[<span class="org-string">"pods_in_phase_Failed"</span>] = 2
      output[<span class="org-string">"pods_in_phase_Unknown"</span>] = 0
    <span class="org-keyword">elseif</span> time_idx == 1 <span class="org-keyword">then</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">The pending pod succeeded.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">Succeeded</span>
<span class="org-string">Failed</span>
<span class="org-string">Failed</span>
<span class="org-string">Succeeded</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"pods"</span>] = 4
      output[<span class="org-string">"pods_in_phase_Pending"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Running"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Succeeded"</span>] = 2
      output[<span class="org-string">"pods_in_phase_Failed"</span>] = 2
      output[<span class="org-string">"pods_in_phase_Unknown"</span>] = 0
    <span class="org-keyword">else</span>
      <span class="org-comment-delimiter">-- </span><span class="org-comment">The older pods were deleted.</span>
      input = <span class="org-string">[[</span>
<span class="org-string">Succeeded</span>
<span class="org-string">]]</span>
      output[<span class="org-string">"pods"</span>] = 1
      output[<span class="org-string">"pods_in_phase_Pending"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Running"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Succeeded"</span>] = 1
      output[<span class="org-string">"pods_in_phase_Failed"</span>] = 0
      output[<span class="org-string">"pods_in_phase_Unknown"</span>] = 0
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">return</span> {input=input, output=output}
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">-- </span><span class="org-comment">This "readers" function mirrors the regular "readers" function, except that</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">it requires an additional "time_idx".</span>
<span class="org-keyword">function</span> <span class="org-function-name">KubeFake.readers</span> (<span class="org-variable-name">resource_opts</span>, <span class="org-variable-name">time_idx</span>)
  <span class="org-keyword">local</span> <span class="org-variable-name">context</span> = resource_opts[<span class="org-string">"context"</span>]
  <span class="org-keyword">local</span> <span class="org-variable-name">namespace</span> = resource_opts[<span class="org-string">"namespace"</span>]

  <span class="org-keyword">return</span> {
    <span class="org-comment-delimiter">-- </span><span class="org-comment">For the "get_pods" parser, use the get_pods_fake function.</span>
    get_pods = get_pods_fake(context, namespace, time_idx)
  }

<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">KubeFake.resource_id_func</span> (<span class="org-variable-name">resource_opts</span>)
  <span class="org-keyword">return</span> resource_opts[<span class="org-string">"context"</span>] .. <span class="org-string">":"</span> .. resource_opts[<span class="org-string">"namespace"</span>]
<span class="org-keyword">end</span>

<span class="org-keyword">return</span> KubeFake
</pre></div>
</div>
</div>
</div>
</div>

<div id="outline-container-h-On-correctness" class="outline-3">
<h3 id="h-On-correctness"><span class="section-number-3">2.4.</span> On correctness</h3>
<div class="outline-text-3" id="text-h-On-correctness">
<p>
FIXME: The sample above is actually part of a test case we use in Melby. You can
be confident that the above example will always work.
</p>

<p>
FIXME: Maybe create some "standard configuration library" of pre-configured Lua
modules for users. For example, we could promote the above "Git" module (and
maybe another Kubernetes one) into a standard folder that ships with Melby.
</p>

<p>
Below is a sample shell script that calls <code>melbyc</code> as a real example. You can use
something similar to set your own shell prompt &#x2014; as <code>melbyc</code> here just outputs
a shell script, you just need to source it and use the variables, just like in
the <code>main()</code> function.
</p>

<div class="org-src-container"><pre class="src src-sh" id="nil-11"><span class="org-builtin">set</span> -euo pipefail

<span class="org-variable-name">SCRIPT_ROOT</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">dirname "$(realpath "$0"</span><span class="org-string">)")"</span>

<span class="org-builtin">export</span> <span class="org-variable-name">HOST</span>=<span class="org-string">"somehost"</span>
<span class="org-builtin">export</span> <span class="org-variable-name">MELBY_ZSH_KEYMAP_INDICATOR</span>=<span class="org-string">"${1:-I}"</span>
<span class="org-builtin">export</span> <span class="org-variable-name">MELBY_LAST_CMD_EXIT_STATUS</span>=<span class="org-string">"${2:-127}"</span>
<span class="org-builtin">export</span> <span class="org-variable-name">MELBY_PATH_ALIASES_FILE</span>=<span class="org-string">"${SCRIPT_ROOT}/sample/path-aliases"</span>
<span class="org-builtin">export</span> MELBY_WANT_KUBECTL_ERROR
<span class="org-variable-name">MELBY_DIR</span>=<span class="org-string">"${SCRIPT_ROOT}/sample"</span>
<span class="org-variable-name">LUA_PATH</span>=<span class="org-string">"${SCRIPT_ROOT}/sample/?.lua"</span>
<span class="org-variable-name">MELBYC_PATH</span>=<span class="org-string">"${SCRIPT_ROOT}/../../client/melbyc"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">50052 is the port used for the development environment (run-dev).</span>
<span class="org-variable-name">MELBYD_PORT</span>=<span class="org-string">"${MELBYD_PORT:-50052}"</span>

<span class="org-function-name">usage</span>()
{
    &gt;&amp;2 cat &lt;&lt;-EOF
<span class="org-sh-heredoc">    usage:   $0 ZSH_KEYMAP_INDICATOR LAST_CMD_EXIT_STATUS SHELL_PID</span>
<span class="org-sh-heredoc">    example: $0 I 128 \$\$</span>
<span class="org-sh-heredoc">EOF</span>
}

<span class="org-function-name">get_view</span>()
{
    <span class="org-string">"${MELBYC_PATH}"</span> <span class="org-sh-escaped-newline">\</span>
        --melbyd-port <span class="org-string">"${MELBYD_PORT}"</span> <span class="org-sh-escaped-newline">\</span>
        view <span class="org-string">"${SCRIPT_ROOT}/sample/melby.lua"</span> <span class="org-sh-escaped-newline">\</span>
        --shell-pid <span class="org-string">"${3:-0}"</span>
}

<span class="org-function-name">main</span>()
{
    get_view <span class="org-string">"$@"</span>
}

main <span class="org-string">"$@"</span>
</pre></div><div class="org-src-container"><pre class="src src-sh" id="nil-12"><span class="org-comment-delimiter"># </span><span class="org-comment">Kubernetes main repo.</span>
<span class="org-builtin">hash</span> -d   <span class="org-variable-name">kk</span>=${<span class="org-variable-name">HOME</span>}/go/src/k8s.io/kubernetes
</pre></div>
</div>
</div>
</div>
</div>
</body>
</html>
